<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C.E.S.T.I.S ‚Äî Virement Request Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <!-- Google Identity Services for OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --navy: #0a1628;
            --navy-mid: #132240;
            --navy-light: #1a3058;
            --gold: #d4a843;
            --gold-dim: #a07d2e;
            --gold-bright: #f0c75e;
            --emerald: #10b981;
            --rose: #f43f5e;
            --sky: #38bdf8;
            --slate: #94a3b8;
            --slate-dim: #64748b;
            --surface: #0f1d35;
            --card: #162544;
            --border: rgba(212,168,67,0.12);
            --text: #e2e8f0;
            --text-dim: #94a3b8;
            --radius: 10px;
            /* Cloud sync modal variables */
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --text-secondary: #94a3b8;
            --text-primary: #e2e8f0;
            --success-bg: rgba(16,185,129,0.1);
            --success: #10b981;
            --info-bg: rgba(56,189,248,0.1);
            --info: #38bdf8;
            --info-border: rgba(56,189,248,0.3);
            --bg-secondary: #132240;
            --border-light: rgba(212,168,67,0.2);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --accent: #d4a843;
            --font-mono: 'Courier New', monospace;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--navy);
            color: var(--text);
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ */
        .topbar {
            background: linear-gradient(135deg, var(--navy-mid), var(--navy));
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky; top: 0; z-index: 100;
        }
        .topbar-brand {
            display: flex; align-items: center; gap: 1rem;
        }
        .topbar-brand .logo {
            min-width: 48px; height: 48px; padding: 0 8px;
            background: linear-gradient(135deg, var(--gold), var(--gold-dim));
            border-radius: 8px;
            display: grid; place-items: center;
            font-weight: 700; font-size: 0.65rem; color: var(--navy);
            letter-spacing: 1.5px; line-height: 1;
            text-align: center; white-space: nowrap;
        }
        .topbar-brand h1 {
            font-family: 'Playfair Display', serif;
            font-size: 0.85rem; color: white; letter-spacing: 0.5px;
        }
        .topbar-brand p {
            font-size: 0.72rem; color: var(--gold); text-transform: uppercase;
            letter-spacing: 2px; margin-top: 2px;
        }
        .topbar-actions { display:flex; gap:0.5rem; }
        .topbar-actions button {
            padding: 0.5rem 1rem; border:none; border-radius:6px;
            font-family: inherit; font-size:0.8rem; font-weight:600;
            cursor:pointer; transition:all 0.2s;
        }
        .btn-gold { background: var(--gold); color: var(--navy); }
        .btn-gold:hover { background: var(--gold-bright); }
        .btn-ghost { background: transparent; color: var(--text); border: 1px solid var(--border) !important; }
        .btn-ghost:hover { background: rgba(255,255,255,0.05); }
        .btn-emerald { background: var(--emerald); color: white; }
        .btn-emerald:hover { background: #059669; }
        .btn-rose { background: var(--rose); color: white; }
        .btn-rose:hover { background: #dc2626; }

        /* ‚îÄ‚îÄ‚îÄ TAB NAV ‚îÄ‚îÄ‚îÄ */
        .tab-nav {
            display: flex; gap:0;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0 2rem;
        }
        .tab-btn {
            padding: 0.85rem 1.5rem;
            background: transparent; border:none;
            color: var(--text-dim); font-family:inherit;
            font-size: 0.82rem; font-weight: 600;
            cursor: pointer; position:relative;
            transition: color 0.2s;
            letter-spacing: 0.3px;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--gold); }
        .tab-btn.active::after {
            content:''; position:absolute; bottom:0; left:0; right:0;
            height:2px; background: var(--gold);
        }

        /* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
        .main { padding: 1.5rem 2rem 3rem; max-width: 1500px; margin: 0 auto; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* ‚îÄ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ‚îÄ */
        .stat-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
            gap: 1rem; margin-bottom: 1.5rem;
        }
        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.25rem;
            position: relative; overflow: hidden;
        }
        .stat-card::before {
            content:''; position:absolute; top:0; left:0;
            width:3px; height:100%;
        }
        .stat-card.gold::before { background: var(--gold); }
        .stat-card.emerald::before { background: var(--emerald); }
        .stat-card.rose::before { background: var(--rose); }
        .stat-card.sky::before { background: var(--sky); }
        .stat-card .label {
            font-size:0.7rem; text-transform:uppercase;
            letter-spacing:1.5px; color: var(--text-dim);
            margin-bottom: 0.5rem;
        }
        .stat-card .value {
            font-size: 1.6rem; font-weight: 700; color: white;
        }
        .stat-card .sub {
            font-size:0.75rem; color: var(--text-dim); margin-top:0.25rem;
        }

        /* ‚îÄ‚îÄ‚îÄ BUDGET TABLE ‚îÄ‚îÄ‚îÄ */
        .table-wrap {
            background: var(--card); border: 1px solid var(--border);
            border-radius: var(--radius); overflow: hidden;
        }
        .table-header {
            padding: 1rem 1.25rem;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
        }
        .table-header h3 {
            font-size: 0.95rem; color: white;
        }
        table {
            width: 100%; border-collapse: collapse;
        }
        th {
            text-align: left; padding: 0.7rem 1rem;
            font-size: 0.7rem; text-transform: uppercase;
            letter-spacing: 1px; color: var(--text-dim);
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        td {
            padding: 0.65rem 1rem;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            white-space: nowrap;
        }
        tr:hover td { background: rgba(255,255,255,0.02); }
        .num { text-align: right; font-variant-numeric: tabular-nums; }
        .pos { color: var(--emerald); }
        .neg { color: var(--rose); }
        .zero { color: var(--text-dim); }

        /* ‚îÄ‚îÄ‚îÄ VIREMENT FORM ‚îÄ‚îÄ‚îÄ */
        .form-section {
            background: var(--card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .form-section h3 {
            font-size: 1rem; color: var(--gold);
            margin-bottom: 1rem; padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr));
            gap: 1rem;
        }
        .field label {
            display: block; font-size: 0.75rem;
            text-transform: uppercase; letter-spacing: 1px;
            color: var(--text-dim); margin-bottom: 0.35rem;
        }
        .field input, .field select, .field textarea {
            width: 100%; padding: 0.6rem 0.8rem;
            background: var(--navy); border: 1px solid var(--border);
            border-radius: 6px; color: white;
            font-family: inherit; font-size: 0.85rem;
        }
        .field input:focus, .field select:focus, .field textarea:focus {
            outline: none; border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212,168,67,0.12);
        }
        .field select option { background: var(--navy); }

        /* ‚îÄ‚îÄ‚îÄ VIREMENT ENTRIES ‚îÄ‚îÄ‚îÄ */
        .virement-entry {
            background: var(--navy);
            border: 1px solid var(--border);
            border-radius: 8px; padding: 1rem;
            margin-bottom: 0.75rem;
            display: grid;
            grid-template-columns: 1fr 160px 1fr 40px;
            gap: 0.75rem; align-items: end;
        }
        .virement-entry .remove-btn {
            background: rgba(244,63,94,0.15); border: 1px solid rgba(244,63,94,0.3);
            color: var(--rose); border-radius:6px; padding: 0.6rem;
            cursor:pointer; font-size:1rem;
        }
        .virement-entry .remove-btn:hover { background: rgba(244,63,94,0.3); }

        .arrow-indicator {
            display: flex; align-items: center; justify-content: center;
            color: var(--gold); font-size: 1.5rem;
            padding-bottom: 0.3rem;
        }

        /* ‚îÄ‚îÄ‚îÄ VIREMENT LIST ‚îÄ‚îÄ‚îÄ */
        .virement-list-item {
            background: var(--card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: border-color 0.2s;
        }
        .virement-list-item:hover { border-color: var(--gold); }
        .virement-list-item .vl-info h4 {
            font-size: 0.9rem; color: white; margin-bottom: 0.25rem;
        }
        .virement-list-item .vl-info p {
            font-size: 0.78rem; color: var(--text-dim);
        }
        .virement-list-item .vl-amount {
            font-size: 1.1rem; font-weight: 700; color: var(--gold);
        }
        .badge {
            display: inline-block; padding: 0.15rem 0.5rem;
            border-radius: 4px; font-size: 0.68rem;
            font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-pending { background: rgba(245,158,11,0.15); color: #fbbf24; }
        .badge-approved { background: rgba(16,185,129,0.15); color: var(--emerald); }
        .badge-rejected { background: rgba(244,63,94,0.15); color: var(--rose); }

        /* ‚îÄ‚îÄ‚îÄ ADMIN APPROVAL PAGE ‚îÄ‚îÄ‚îÄ */
        .admin-gate {
            max-width: 400px; margin: 3rem auto; text-align: center;
            background: var(--card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 2.5rem 2rem;
        }
        .admin-gate h3 { color: var(--gold); margin-bottom: 0.5rem; font-size: 1.1rem; }
        .admin-gate p { color: var(--text-dim); font-size: 0.82rem; margin-bottom: 1.5rem; }
        .admin-gate .pin-input {
            width: 180px; text-align: center; padding: 0.6rem 1rem;
            background: var(--surface); color: var(--text); border: 1px solid var(--border);
            border-radius: 6px; font-size: 1.1rem; letter-spacing: 6px;
            font-family: 'Courier New', monospace;
        }
        .admin-gate .pin-input:focus { outline: none; border-color: var(--gold); }
        .admin-gate .pin-error {
            color: var(--rose); font-size: 0.78rem; margin-top: 0.5rem; min-height: 1.2em;
        }
        .admin-gate .btn-gold { margin-top: 1rem; padding: 0.6rem 2rem; }

        .approval-stats {
            display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;
        }
        .approval-stat-card {
            flex: 1; min-width: 140px; background: var(--card);
            border: 1px solid var(--border); border-radius: var(--radius);
            padding: 1rem 1.25rem; text-align: center;
        }
        .approval-stat-card .stat-num {
            font-size: 1.8rem; font-weight: 700; line-height: 1;
        }
        .approval-stat-card .stat-num.pending-num { color: #fbbf24; }
        .approval-stat-card .stat-num.approved-num { color: var(--emerald); }
        .approval-stat-card .stat-num.rejected-num { color: var(--rose); }
        .approval-stat-card .stat-label {
            font-size: 0.72rem; color: var(--text-dim); text-transform: uppercase;
            letter-spacing: 1px; margin-top: 0.25rem;
        }

        .approval-list-item {
            background: var(--card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.25rem;
            margin-bottom: 0.75rem; transition: border-color 0.2s;
        }
        .approval-list-item:hover { border-color: var(--gold); }
        .approval-list-item .ali-top {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        .approval-list-item .ali-top h4 {
            font-size: 0.9rem; color: white; margin-bottom: 0.2rem;
        }
        .approval-list-item .ali-top .ali-amount {
            font-size: 1.1rem; font-weight: 700; color: var(--gold); white-space: nowrap;
        }
        .approval-list-item .ali-meta {
            display: flex; gap: 1.5rem; flex-wrap: wrap;
            font-size: 0.78rem; color: var(--text-dim); margin-bottom: 0.75rem;
        }
        .approval-list-item .ali-lines {
            font-size: 0.78rem; color: var(--text-dim);
            margin-bottom: 0.75rem; font-style: italic;
        }
        .approval-list-item .ali-actions {
            display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;
        }
        .approval-list-item .ali-actions .btn-approve {
            background: var(--emerald); color: white; border: none; border-radius: 6px;
            padding: 0.45rem 1.25rem; font-family: inherit; font-size: 0.8rem;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .approval-list-item .ali-actions .btn-approve:hover { background: #059669; }
        .approval-list-item .ali-actions .btn-reject {
            background: var(--rose); color: white; border: none; border-radius: 6px;
            padding: 0.45rem 1.25rem; font-family: inherit; font-size: 0.8rem;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .approval-list-item .ali-actions .btn-reject:hover { background: #e11d48; }
        .approval-list-item .ali-actions .approval-comment-input {
            flex: 1; min-width: 200px; padding: 0.4rem 0.75rem;
            background: var(--surface); color: var(--text); border: 1px solid var(--border);
            border-radius: 6px; font-family: inherit; font-size: 0.8rem;
        }
        .approval-list-item .ali-actions .approval-comment-input:focus { outline: none; border-color: var(--gold); }
        .approval-list-item .ali-stamp {
            margin-top: 0.75rem; padding: 0.6rem 0.75rem;
            border-radius: 6px; font-size: 0.78rem;
        }
        .ali-stamp.stamp-approved {
            background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.25);
            color: var(--emerald);
        }
        .ali-stamp.stamp-rejected {
            background: rgba(244,63,94,0.1); border: 1px solid rgba(244,63,94,0.25);
            color: var(--rose);
        }
        .admin-filter-bar {
            display: flex; gap: 0.5rem; margin-bottom: 1.25rem; flex-wrap: wrap;
        }
        .admin-filter-btn {
            padding: 0.4rem 1rem; border: 1px solid var(--border); border-radius: 6px;
            background: transparent; color: var(--text-dim); font-family: inherit;
            font-size: 0.78rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .admin-filter-btn:hover { color: var(--text); background: rgba(255,255,255,0.04); }
        .admin-filter-btn.active { background: var(--gold); color: var(--navy); border-color: var(--gold); }

        /* ‚îÄ‚îÄ‚îÄ PRINT PREVIEW ‚îÄ‚îÄ‚îÄ */
        .print-frame {
            background: white; color: #111; border-radius: var(--radius);
            padding: 0; max-width: 800px; margin: 0 auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            overflow: hidden;
        }
        .print-page {
            padding: 2.5rem 2rem;
            page-break-after: always;
            min-height: auto;
        }
        .print-page + .print-page {
            border-top: 2px dashed #ccc;
        }
        .print-header {
            text-align: center; margin-bottom: 1.5rem;
            border-bottom: 3px solid #000; padding-bottom: 1rem;
        }
        .print-header h1 { font-size: 1.05rem; font-weight:bold; margin-bottom:0.15rem; color: #000; font-family: 'DM Sans', Arial, sans-serif; }
        .print-header h2 { font-size: 0.9rem; font-weight:normal; color: #333; }
        .print-header h3 { font-size: 1.1rem; font-weight:bold; margin-top:0.5rem; letter-spacing: 1px; color: #000; }
        .print-body p { font-size:0.88rem; line-height:1.7; color:#222; margin-bottom:0.5rem; }
        .print-body .amount-highlight {
            font-weight:700; color:#000;
        }
        .print-table {
            width:100%; border-collapse:collapse; margin: 1rem 0;
        }
        .print-table th, .print-table td {
            border: 1px solid #333; padding: 0.5rem 0.75rem;
            font-size: 0.82rem; color: #000;
        }
        .print-table th {
            background: #e5e7eb; font-weight:600; text-align:left;
        }
        .print-total-row {
            font-weight: 700; font-size: 0.95rem;
            padding: 0.75rem 0; margin: 0.5rem 0;
            border-top: 2px solid #000;
            color: #000;
        }

        /* ‚îÄ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ‚îÄ */
        .chart-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 1.5rem; margin-bottom: 1.5rem;
        }
        .chart-card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.25rem;
        }
        .chart-card h4 {
            font-size: 0.85rem; color: var(--gold);
            margin-bottom: 1rem;
        }
        .bar-chart { display:flex; flex-direction:column; gap:0.5rem; }
        .bar-row {
            display: grid; grid-template-columns: 130px 1fr 80px; gap:0.5rem; align-items: center;
        }
        .bar-label { font-size:0.72rem; color: var(--text-dim); text-align:right; overflow:hidden; text-overflow:ellipsis; }
        .bar-track { height:18px; background: rgba(255,255,255,0.05); border-radius:3px; overflow:hidden; position:relative; }
        .bar-fill { height:100%; border-radius:3px; transition: width 0.5s ease; }
        .bar-fill.surplus { background: linear-gradient(90deg, var(--emerald), #34d399); }
        .bar-fill.deficit { background: linear-gradient(90deg, var(--rose), #fb7185); }
        .bar-value { font-size:0.72rem; font-variant-numeric:tabular-nums; }

        /* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
        .modal-overlay {
            display:none; position:fixed; inset:0;
            background: rgba(0,0,0,0.7); z-index:200;
            align-items:center; justify-content:center;
        }
        .modal-overlay.show { display:flex; }
        .modal {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 12px; max-width:900px; width:95%;
            max-height:90vh; overflow-y:auto; padding: 2rem;
        }
        .modal h2 { color: var(--gold); margin-bottom: 1rem; font-size: 1.1rem; }

        /* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
        @media (max-width:900px) {
            .chart-grid { grid-template-columns: 1fr; }
            .virement-entry { grid-template-columns: 1fr; }
            .topbar { flex-direction: column; gap:0.75rem; }
            .main { padding: 1rem; }
        }

        /* ‚îÄ‚îÄ‚îÄ PRINT ‚îÄ‚îÄ‚îÄ */
        @media print {
            body { background: white; }
            .topbar, .tab-nav, .no-print { display: none !important; }
            .main { padding: 0; max-width: 100%; }
            .tab-panel { display: none !important; }
            .tab-panel.print-active { display: block !important; }
            .print-frame { box-shadow: none; border-radius: 0; }
            .print-page { padding: 1.5rem; }
        }

        /* ‚îÄ‚îÄ‚îÄ QUARTER SELECTOR ‚îÄ‚îÄ‚îÄ */
        .quarter-bar {
            display: flex; align-items: center; gap: 0.75rem;
            margin-bottom: 1.25rem; flex-wrap: wrap;
        }
        .quarter-tabs {
            display: flex; gap: 0; background: var(--surface);
            border: 1px solid var(--border); border-radius: 8px;
            overflow: hidden;
        }
        .quarter-tab-btn {
            padding: 0.55rem 1.1rem; border: none; background: transparent;
            color: var(--text-dim); font-family: inherit; font-size: 0.78rem;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            letter-spacing: 0.3px; white-space: nowrap;
        }
        .quarter-tab-btn:hover { color: var(--text); background: rgba(255,255,255,0.04); }
        .quarter-tab-btn.active { background: var(--gold); color: var(--navy); }
        .quarter-tab-btn + .quarter-tab-btn { border-left: 1px solid var(--border); }
        .quarter-tab-btn .q-data-dot {
            display: inline-block; width: 6px; height: 6px; border-radius: 50%;
            margin-left: 5px; vertical-align: middle;
        }
        .quarter-tab-btn .q-data-dot.has-data { background: var(--emerald); box-shadow: 0 0 4px rgba(16,185,129,0.5); }
        .quarter-tab-btn .q-data-dot.no-data { background: var(--slate-dim); opacity: 0.4; }
        .quarter-tab-btn.active .q-data-dot.has-data { background: #065f46; box-shadow: none; }
        .quarter-tab-btn.active .q-data-dot.no-data { background: rgba(10,22,40,0.3); box-shadow: none; }
        .quarter-fy {
            font-size: 0.78rem; color: var(--gold); font-weight: 700;
            letter-spacing: 1px; font-family: 'DM Sans', sans-serif;
        }
        .fy-selector {
            display: flex; align-items: center; gap: 0;
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 8px; overflow: hidden;
        }
        .fy-select {
            background: transparent; border: none; color: var(--gold);
            font-family: 'DM Sans', sans-serif; font-size: 0.78rem;
            font-weight: 700; letter-spacing: 0.5px; padding: 0.45rem 0.3rem;
            cursor: pointer; text-align: center; appearance: none;
            -webkit-appearance: none; -moz-appearance: none;
            outline: none; min-width: 7.5rem;
        }
        .fy-select option {
            background: var(--navy); color: var(--text);
        }
        .fy-nav-btn {
            background: transparent; border: none; color: var(--text-dim);
            font-size: 0.65rem; padding: 0.45rem 0.5rem; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center;
        }
        .fy-nav-btn:hover { color: var(--gold); background: rgba(255,255,255,0.04); }
        .quarter-sync-btn {
            margin-left: auto; padding: 0.45rem 0.9rem;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none; border-radius: 6px; color: white;
            font-family: inherit; font-size: 0.75rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s; display: flex;
            align-items: center; gap: 0.4rem;
        }
        .quarter-sync-btn:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(16,185,129,0.3); }
        .quarter-sync-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .budget-source-badge {
            font-size: 0.65rem; padding: 0.2rem 0.6rem; border-radius: 4px;
            font-weight: 600; letter-spacing: 0.5px;
        }
        .budget-source-badge.synced { background: rgba(16,185,129,0.15); color: var(--emerald); }
        .budget-source-badge.default { background: rgba(148,163,184,0.1); color: var(--slate); }
        .budget-source-badge.cloud { background: rgba(56,189,248,0.15); color: var(--sky); }
        .budget-source-badge.no-data { background: rgba(244,63,94,0.12); color: var(--rose); }
        .quarter-empty-banner {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 1rem 1.25rem; margin-bottom: 1.25rem;
            background: rgba(244,63,94,0.06); border: 1px solid rgba(244,63,94,0.15);
            border-radius: 8px; color: var(--text-dim); font-size: 0.82rem;
        }
        .quarter-empty-banner .banner-icon { font-size: 1.3rem; }
        .quarter-empty-banner strong { color: var(--rose); }

        /* scrollbar */
        ::-webkit-scrollbar { width:6px; }
        ::-webkit-scrollbar-track { background: var(--navy); }
        ::-webkit-scrollbar-thumb { background: var(--navy-light); border-radius:3px; }

        /* ‚îÄ‚îÄ‚îÄ CLOUD SYNC DROPDOWN ‚îÄ‚îÄ‚îÄ */
        .cloud-sync-wrapper {
            display: flex; align-items: center; gap: 0.5rem;
        }
        .cloud-status-label {
            display: flex; align-items: center; gap: 6px;
            font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 1.5px; color: var(--text-dim);
            padding: 0.35rem 0.6rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 6px;
        }
        .cloud-status-label.connected { color: var(--emerald); border-color: rgba(16,185,129,0.3); }
        .cloud-status-label .status-text {
            font-size: 0.65rem; font-weight: 600; letter-spacing: 0.5px;
        }
        .cloud-sync-btn {
            display: flex; align-items: center; gap: 6px;
            padding: 0.5rem 1rem; background: transparent;
            border: 1px solid var(--border); border-radius: 6px;
            color: var(--text); font-family: inherit;
            font-size: 0.8rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .cloud-sync-btn:hover { background: rgba(255,255,255,0.05); }
        .cloud-dropdown { position: relative; display: inline-block; }
        .cloud-dropdown-content {
            display: none; position: absolute; right: 0; top: 100%;
            background: var(--card); min-width: 240px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border-radius: 10px; border: 1px solid var(--border);
            z-index: 1000; overflow: hidden; margin-top: 6px;
            padding: 6px;
        }
        .cloud-dropdown-content.show { display: block; }
        .cloud-dropdown-item {
            padding: 10px 14px; display: flex; align-items: center;
            gap: 10px; cursor: pointer; font-size: 0.82rem;
            color: white; font-weight: 600;
            border-radius: 8px; margin-bottom: 4px;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .cloud-dropdown-item:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .cloud-dropdown-item:active { transform: translateY(0); }
        .cloud-dropdown-item.item-save {
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
        }
        .cloud-dropdown-item.item-sync {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .cloud-dropdown-item.item-merge {
            background: linear-gradient(135deg, #a855f7, #ec4899);
        }
        .cloud-dropdown-item.item-browse {
            background: linear-gradient(135deg, #f59e0b, #f97316);
        }
        .cloud-dropdown-item.danger {
            background: transparent; color: var(--rose);
            font-weight: 500; margin-bottom: 0;
        }
        .cloud-dropdown-item.danger:hover {
            background-color: rgba(244,63,94,0.1);
            transform: none; box-shadow: none;
        }
        .cloud-dropdown-divider { height: 1px; background: var(--border); margin: 4px 0; }
        .last-sync-info { padding: 6px 14px; font-size: 0.72rem; color: var(--slate); }
        .cloud-status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--slate); display: inline-block;
        }
        .cloud-status-dot.connected { background: var(--emerald); box-shadow: 0 0 6px rgba(16,185,129,0.5); }
        .cloud-status-dot.syncing { background: #f59e0b; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .spinning { display: inline-block; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ‚îÄ CLOUD AUTH MODAL ‚îÄ‚îÄ‚îÄ */
        .google-auth-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex;
            align-items: center; justify-content: center; z-index: 10000;
        }
        .google-auth-modal .modal-content {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 12px; max-width: 560px; width: 95%;
            max-height: 90vh; overflow-y: auto;
        }
        .google-auth-modal .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border);
        }
        .google-auth-modal .modal-header h2 {
            color: var(--gold); font-size: 1.1rem; margin: 0;
        }
        .google-auth-modal .close-btn {
            background: transparent; border: none; color: var(--text-dim);
            font-size: 1.5rem; cursor: pointer; padding: 0 0.25rem;
        }
        .google-auth-modal .close-btn:hover { color: var(--text); }
        .google-auth-modal .btn {
            padding: 0.6rem 1.2rem; border: none; border-radius: 6px;
            font-family: inherit; font-size: 0.85rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .google-auth-modal .btn-success { background: var(--emerald); color: white; }
        .google-auth-modal .btn-success:hover { background: #059669; }
        .google-auth-modal .btn-secondary {
            background: transparent; color: var(--text);
            border: 1px solid var(--border);
        }
        .google-auth-modal .btn-secondary:hover { background: rgba(255,255,255,0.05); }

        /* ‚îÄ‚îÄ‚îÄ FOLDER BROWSER MODAL ‚îÄ‚îÄ‚îÄ */
        .folder-browser-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex;
            align-items: center; justify-content: center; z-index: 10000;
        }
        .folder-browser {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 14px; max-width: 620px; width: 95%;
            max-height: 85vh; display: flex; flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .folder-browser-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1.1rem 1.5rem; border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .folder-browser-header h2 {
            color: var(--gold); font-size: 1rem; margin: 0;
            display: flex; align-items: center; gap: 0.5rem; font-weight: 700;
        }
        .folder-browser-close {
            background: transparent; border: none; color: var(--text-dim);
            font-size: 1.4rem; cursor: pointer; padding: 0.15rem 0.35rem;
            border-radius: 6px; transition: all 0.2s; line-height: 1;
        }
        .folder-browser-close:hover { color: var(--text); background: rgba(255,255,255,0.08); }
        .folder-browser-body {
            padding: 0.75rem 1rem; overflow-y: auto; flex: 1;
        }
        .folder-browser-empty {
            text-align: center; padding: 2.5rem 1rem; color: var(--slate);
        }
        .folder-browser-empty span { font-size: 2rem; display: block; margin-bottom: 0.75rem; }
        .folder-file-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.85rem 1rem; border-radius: 10px;
            background: var(--surface); border: 1px solid rgba(255,255,255,0.04);
            margin-bottom: 0.5rem; transition: border-color 0.2s;
        }
        .folder-file-item:hover { border-color: var(--border); }
        .folder-file-info { display: flex; align-items: center; gap: 0.75rem; min-width: 0; flex: 1; }
        .folder-file-icon {
            width: 36px; height: 36px; border-radius: 8px;
            background: linear-gradient(135deg, #f59e0b, #f97316);
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; flex-shrink: 0;
        }
        .folder-file-details { min-width: 0; }
        .folder-file-name {
            font-size: 0.82rem; font-weight: 600; color: var(--text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            max-width: 300px;
        }
        .folder-file-meta {
            font-size: 0.7rem; color: var(--slate-dim); margin-top: 2px;
            display: flex; gap: 0.75rem; flex-wrap: wrap;
        }
        .folder-file-actions { display: flex; gap: 0.4rem; flex-shrink: 0; margin-left: 0.75rem; }
        .folder-btn-download {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 0.35rem 0.7rem; border: none; border-radius: 6px;
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            color: white; font-family: inherit; font-size: 0.72rem;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            white-space: nowrap;
        }
        .folder-btn-download:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(14,165,233,0.3); }
        .folder-btn-delete {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.35rem 0.5rem; border: none; border-radius: 6px;
            background: rgba(244,63,94,0.12); color: var(--rose);
            font-family: inherit; font-size: 0.8rem; cursor: pointer;
            transition: all 0.2s;
        }
        .folder-btn-delete:hover { background: rgba(244,63,94,0.25); transform: translateY(-1px); }
        .folder-browser-footer {
            padding: 0.85rem 1.5rem; border-top: 1px solid var(--border);
            text-align: center; flex-shrink: 0;
        }
        .folder-browser-footer a {
            color: var(--sky); font-size: 0.8rem; font-weight: 600;
            text-decoration: none; display: inline-flex; align-items: center; gap: 0.4rem;
        }
        .folder-browser-footer a:hover { text-decoration: underline; }
        @media (max-width: 600px) {
            .folder-file-name { max-width: 160px; }
            .folder-file-item { flex-wrap: wrap; gap: 0.5rem; }
            .folder-file-actions { margin-left: 0; width: 100%; justify-content: flex-end; }
        }

        /* Cloud Sync Notification Popup */
        .cloud-notify{position:fixed;top:1.25rem;right:1.25rem;z-index:9999;width:370px;max-width:calc(100vw - 2rem);background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.45);transform:translateX(120%);transition:transform .4s cubic-bezier(.22,1,.36,1);overflow:hidden}
        .cloud-notify.show{transform:translateX(0)}
        .cloud-notify.warn{border-color:var(--gold)}
        .cloud-notify.error{border-color:var(--danger)}
        .cloud-notify-bar{height:4px;width:100%}
        .cloud-notify.warn .cloud-notify-bar{background:var(--gold)}
        .cloud-notify.error .cloud-notify-bar{background:var(--danger)}
        .cloud-notify-body{padding:1rem 1.25rem;display:flex;gap:.75rem;align-items:flex-start}
        .cloud-notify-icon{font-size:1.6rem;flex-shrink:0;line-height:1}
        .cloud-notify-content{flex:1;min-width:0}
        .cloud-notify-title{font-size:.9rem;font-weight:700;margin-bottom:.3rem}
        .cloud-notify.warn .cloud-notify-title{color:var(--gold)}
        .cloud-notify.error .cloud-notify-title{color:var(--danger)}
        .cloud-notify-msg{font-size:.8rem;color:var(--text-dim);line-height:1.45}
        .cloud-notify-close{background:none;border:none;color:var(--text-muted);font-size:1.2rem;cursor:pointer;padding:0;line-height:1;flex-shrink:0}
        .cloud-notify-close:hover{color:var(--text)}
        .cloud-notify-actions{padding:0 1.25rem 1rem;display:flex;gap:.5rem}
        .cloud-notify-actions .btn{font-size:.8rem;padding:.45rem .9rem}
        @keyframes notifyCountdown{from{width:100%}to{width:0%}}
        .cloud-notify-timer{height:3px;background:var(--text-muted);opacity:.3;border-radius:0 0 14px 14px}
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOP BAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="topbar">
    <div class="topbar-brand">
        <div class="logo">C.E.S.T.I.S</div>
        <div>
            <h1>Community Educational and Skills Training Institute and Services Limited</h1>
            <p>Virement Dashboard</p>
        </div>
    </div>
    <div class="topbar-actions no-print">
        <button class="btn-ghost" onclick="saveAllData()">üíæ Save</button>
        <button class="btn-ghost" onclick="loadAllData()">üìÇ Load</button>
        <button class="btn-gold" onclick="printVirements()">üñ®Ô∏è Print / PDF</button>
        <!-- Cloud Sync Dropdown -->
        <div id="cloudNotConnected">
            <button class="cloud-sync-btn" onclick="connectToGoogleDrive()">
                <span>‚òÅÔ∏è</span>
                <span id="cloudStatusText">Not connected</span>
                <span id="cloudStatusDot" class="cloud-status-dot"></span>
            </button>
        </div>
        <div id="cloudConnected" style="display: none;">
            <div class="cloud-sync-wrapper">
                <div class="cloud-status-label connected" id="cloudStatusLabel">
                    <span>CLOUD SYNC</span>
                    <span id="cloudStatusDotConnected" class="cloud-status-dot connected"></span>
                    <span class="status-text" id="cloudStatusTextConnected">Connected</span>
                </div>
                <div class="cloud-dropdown">
                    <button class="cloud-sync-btn" onclick="toggleCloudMenu()">
                        <span id="cloudMenuIcon">‚òÅÔ∏è</span>
                        <span>Cloud</span>
                        <span style="font-size: 0.6rem;">‚ñº</span>
                    </button>
                    <div class="cloud-dropdown-content" id="cloudDropdownMenu">
                        <div class="cloud-dropdown-item item-save" onclick="saveToCloud()">
                            <span>üíæ</span>
                            <span>Save to Cloud</span>
                        </div>
                        <div class="cloud-dropdown-item item-sync" onclick="syncFromCloud()">
                            <span>üîÑ</span>
                            <span>Sync from Cloud</span>
                        </div>
                        <div class="cloud-dropdown-item item-merge" onclick="mergeFromCloud()">
                            <span>üîÄ</span>
                            <span>Merge from Cloud</span>
                        </div>
                        <div class="cloud-dropdown-item item-browse" onclick="browseBackupFiles()">
                            <span>üìÅ</span>
                            <span>Browse All Backups</span>
                        </div>
                        <div class="cloud-dropdown-divider"></div>
                        <div class="cloud-dropdown-item" onclick="syncBudgetFromCloudMenu()" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <span>üìä</span>
                            <span>Sync Budget from Cashbook</span>
                        </div>
                        <div class="cloud-dropdown-divider"></div>
                        <div class="last-sync-info" id="lastSyncInfo">
                            Last sync: Never
                        </div>
                        <div class="last-sync-info" id="lastSavedByInfo" style="color: var(--slate-dim); font-size: 0.7rem;">
                            Last saved by: --
                        </div>
                        <div class="cloud-dropdown-divider"></div>
                        <div class="cloud-dropdown-item danger" onclick="disconnectFromGoogleDrive()">
                            <span>üîå</span>
                            <span>Disconnect</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-nav no-print">
    <button class="tab-btn active" onclick="switchTab('overview',this)">üìä Budget Overview</button>
    <button class="tab-btn" onclick="switchTab('create',this)">‚úèÔ∏è Create Virement</button>
    <button class="tab-btn" onclick="switchTab('requests',this)">üìã Virement Requests</button>
    <button class="tab-btn" onclick="switchTab('preview',this)">üñ®Ô∏è Print Preview</button>
    <button class="tab-btn" onclick="switchTab('admin',this)">üõ°Ô∏è Admin Approvals</button>
    <button class="tab-btn" onclick="window.open('https://stevebarrettsrha-ops.github.io/CESTIS---Cashbook-Dashboard/','_blank')">üìí Cashbook Dashboard</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN CONTENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="main">

<!-- ‚îÄ‚îÄ‚îÄ TAB 1: BUDGET OVERVIEW ‚îÄ‚îÄ‚îÄ -->
<div id="tab-overview" class="tab-panel active">
    <!-- Quarter Selector -->
    <div class="quarter-bar">
        <div class="quarter-tabs">
            <button class="quarter-tab-btn" onclick="switchVirementQuarter(1)">Q1 Apr-Jun<span class="q-data-dot no-data" id="qDot1"></span></button>
            <button class="quarter-tab-btn" onclick="switchVirementQuarter(2)">Q2 Jul-Sep<span class="q-data-dot no-data" id="qDot2"></span></button>
            <button class="quarter-tab-btn" onclick="switchVirementQuarter(3)">Q3 Oct-Dec<span class="q-data-dot no-data" id="qDot3"></span></button>
            <button class="quarter-tab-btn" onclick="switchVirementQuarter(4)">Q4 Jan-Mar<span class="q-data-dot no-data" id="qDot4"></span></button>
        </div>
        <div class="fy-selector">
            <button class="fy-nav-btn" onclick="shiftFiscalYear(-1)" title="Previous Fiscal Year">‚óÄ</button>
            <select id="fySelect" class="fy-select" onchange="switchFiscalYear(this.value)"></select>
            <button class="fy-nav-btn" onclick="shiftFiscalYear(1)" title="Next Fiscal Year">‚ñ∂</button>
        </div>
        <span class="budget-source-badge default" id="budgetSourceBadge">DEFAULT DATA</span>
        <button class="quarter-sync-btn" onclick="syncBudgetFromCashbook()" id="syncBudgetBtn">
            <span>üîÑ</span> Sync Budget from Cashbook
        </button>
    </div>
    <div id="quarterEmptyBanner" class="quarter-empty-banner" style="display:none;">
        <span class="banner-icon">‚ö†Ô∏è</span>
        <span id="quarterEmptyText"><strong>No Cashbook data available for this quarter.</strong> Use <em>Sync Budget from Cashbook</em> to pull cloud data for all available quarters.</span>
    </div>
    <div class="stat-row" id="statsRow"></div>
    <div class="chart-grid" id="chartArea"></div>
    <div class="table-wrap">
        <div class="table-header">
            <h3 id="budgetTableHeader">Budget Line Items ‚Äî OCT to DEC 2025</h3>
            <span style="font-size:0.75rem;color:var(--text-dim)">CESTI / Hazard Skills Training Centre</span>
        </div>
        <div style="overflow-x:auto;">
            <table id="budgetTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Line Item</th>
                        <th class="num">Allocated ($)</th>
                        <th class="num">Actual ($)</th>
                        <th class="num">Variance ($)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="budgetBody"></tbody>
                <tfoot id="budgetFoot"></tfoot>
            </table>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ TAB 2: CREATE VIREMENT ‚îÄ‚îÄ‚îÄ -->
<div id="tab-create" class="tab-panel">
    <div class="form-section">
        <h3>Virement Request Details</h3>
        <div class="form-grid">
            <div class="field">
                <label>Project Name</label>
                <input type="text" id="vProjectName" value="Community Educational and Skills Training Institute and Services Limited (Hazard Skills Training Centre)">
            </div>
            <div class="field">
                <label>Subvention Period</label>
                <input type="text" id="vPeriod" value="October to December 2025">
            </div>
            <div class="field">
                <label>Requested By (Name)</label>
                <input type="text" id="vRequestedBy">
            </div>
            <div class="field">
                <label>Position</label>
                <input type="text" id="vPosition" value="Assistant Coordinator">
            </div>
        </div>
    </div>

    <div class="form-section">
        <h3>Fund Transfer Lines <span style="font-size:0.7rem;color:var(--text-dim);font-weight:400;">(Surplus ‚Üí Deficit)</span></h3>
        <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:1rem;">
            Add one or more transfers. Each line moves funds FROM a surplus line item TO a deficit line item.
        </p>
        <div id="virementLines"></div>
        <button class="btn-emerald" onclick="addVirementLine()" style="margin-top:0.75rem;">+ Add Transfer Line</button>
        <div class="field" style="margin-top:1rem;">
            <label>Reason / Comment</label>
            <textarea id="deficitComment" rows="2" placeholder="Explain why these funds are being transferred..." style="width:100%;resize:vertical;"></textarea>
        </div>
    </div>

    <div class="form-section">
        <h3>Vire to Any Line <span style="font-size:0.7rem;color:var(--gold);font-weight:400;">(Surplus ‚Üí Any Line Item)</span></h3>
        <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:1rem;">
            Transfer funds FROM a surplus line item TO any line item ‚Äî including those that are not in deficit.
        </p>
        <div id="virementAnyLines"></div>
        <button class="btn-emerald" onclick="addAnyLineLine()" style="margin-top:0.75rem;">+ Add Any-Line Transfer</button>
        <div class="field" style="margin-top:1rem;">
            <label>Reason / Comment</label>
            <textarea id="anyLineComment" rows="2" placeholder="Explain why these funds are being transferred..." style="width:100%;resize:vertical;"></textarea>
        </div>
    </div>

    <div class="form-section" style="display:flex;justify-content:space-between;align-items:center;">
        <div>
            <span style="font-size:0.8rem;color:var(--text-dim);">Total Virement Amount:</span>
            <span id="virementTotal" style="font-size:1.3rem;font-weight:700;color:var(--gold);margin-left:0.75rem;">$0.00</span>
        </div>
        <div style="display:flex;gap:0.5rem;">
            <button class="btn-ghost" onclick="clearVirementForm()">Clear</button>
            <button class="btn-gold" onclick="submitVirement()">Submit Virement Request</button>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ TAB 3: VIREMENT REQUESTS ‚îÄ‚îÄ‚îÄ -->
<div id="tab-requests" class="tab-panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;">
        <h3 style="color:white;">Submitted Virement Requests</h3>
        <span id="requestCount" style="font-size:0.8rem;color:var(--text-dim);"></span>
    </div>
    <div id="requestsList"></div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ TAB 4: PRINT PREVIEW ‚îÄ‚îÄ‚îÄ -->
<div id="tab-preview" class="tab-panel">
    <div class="no-print" style="text-align:center;margin-bottom:1.5rem;">
        <button class="btn-gold" onclick="printVirements()" style="padding:0.75rem 2rem;font-size:0.9rem;">üñ®Ô∏è Print All Virement Forms / Save as PDF</button>
        <p style="font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem;">Each virement request generates a separate form page matching the official C.E.S.T.I.S format.</p>
    </div>
    <div id="printPreviewArea" class="print-frame"></div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ TAB 5: ADMIN APPROVALS ‚îÄ‚îÄ‚îÄ -->
<div id="tab-admin" class="tab-panel">
    <!-- PIN Gate (shown when admin not verified) -->
    <div id="adminGate" class="admin-gate">
        <h3>üõ°Ô∏è Admin Access Required</h3>
        <p>Enter the admin PIN to review and approve pending virement requests.</p>
        <input type="password" id="adminPinInput" class="pin-input" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter') verifyAdminPin()">
        <div id="adminPinError" class="pin-error"></div>
        <br>
        <button class="btn-gold" onclick="verifyAdminPin()">Unlock</button>
    </div>
    <!-- Approval Dashboard (shown after PIN verified) -->
    <div id="adminDashboard" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.75rem;">
            <h3 style="color:white;">Admin Approval Dashboard</h3>
            <button class="btn-ghost" onclick="lockAdminPanel()" style="font-size:0.78rem;">üîí Lock Panel</button>
        </div>
        <div class="approval-stats" id="approvalStats"></div>
        <div class="admin-filter-bar" id="adminFilterBar">
            <button class="admin-filter-btn active" onclick="setAdminFilter('pending',this)">Pending</button>
            <button class="admin-filter-btn" onclick="setAdminFilter('all',this)">All</button>
            <button class="admin-filter-btn" onclick="setAdminFilter('approved',this)">Approved</button>
            <button class="admin-filter-btn" onclick="setAdminFilter('rejected',this)">Rejected</button>
        </div>
        <div id="approvalList"></div>
    </div>
</div>

</div><!-- /main -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DETAIL MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="detailModal">
    <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <h2 id="modalTitle">Virement Detail</h2>
            <button class="btn-ghost" onclick="closeModal()" style="font-size:1.2rem;">&times;</button>
        </div>
        <div id="modalBody"></div>
        <div style="display:flex;gap:0.5rem;justify-content:flex-end;margin-top:1.5rem;">
            <button class="btn-rose" id="modalDeleteBtn" onclick="deleteCurrentVirement()">üóë Delete</button>
            <button class="btn-ghost" onclick="closeModal()">Close</button>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  QUARTER CONFIGURATION (matches Cashbook Dashboard)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const QUARTER_META = [
    { q:1, label:'Q1 Apr-Jun', shortLabel:'Apr-Jun', months:['apr','may','jun'], monthNums:[4,5,6], monthNames:['April','May','June'] },
    { q:2, label:'Q2 Jul-Sep', shortLabel:'Jul-Sep', months:['jul','aug','sep'], monthNums:[7,8,9], monthNames:['July','August','September'] },
    { q:3, label:'Q3 Oct-Dec', shortLabel:'Oct-Dec', months:['oct','nov','dec'], monthNums:[10,11,12], monthNames:['October','November','December'] },
    { q:4, label:'Q4 Jan-Mar', shortLabel:'Jan-Mar', months:['jan','feb','mar'], monthNums:[1,2,3], monthNames:['January','February','March'] }
];

// Active quarter state for the Virement Dashboard
// Auto-detect current fiscal year: FY starts in April
const _now = new Date();
const _curMonth = _now.getMonth() + 1;
const _fyStart = _curMonth >= 4 ? _now.getFullYear() : _now.getFullYear() - 1;
let virementActiveFY = _fyStart + '/' + (_fyStart + 1);
// Auto-detect current quarter based on month
let virementActiveQ = _curMonth >= 4 && _curMonth <= 6 ? 1
    : _curMonth >= 7 && _curMonth <= 9 ? 2
    : _curMonth >= 10 && _curMonth <= 12 ? 3 : 4;
let budgetDataSource = 'no-data'; // 'no-data', 'cashbook-cloud'

// Per-quarter cloud cache: stores budget data synced from Google Drive
// Key format: { '2025/2026_Q3': { budget: {...}, transactions: [...] }, ... }
let cloudQuarterCache = {};

// Persistence key for cloud cache in localStorage (virement-specific, not shared with Cashbook)
const VIREMENT_CLOUD_CACHE_KEY = 'cesti_virement_cloud_cache';

// Mapping from Cashbook Dashboard category names to Virement Dashboard IDs/names
const CASHBOOK_CATEGORY_MAP = {
    'Coordinator Salary':       { id:'coordinator',     name:'Coordinator Salary' },
    'Asst. Coordinator':        { id:'asst_coord',      name:'Assistant Coordinator' },
    'Statutory Deductions':     { id:'statutory',        name:'Statutory Deductions' },
    'Admin Expenses':           { id:'admin',            name:'Admin Expenses' },
    'Training Material':        { id:'training_mat',     name:'Training Material' },
    'Assessor Fees':            { id:'assessor',         name:'Assessor Fees' },
    'Utilities':                { id:'utilities',        name:'Utilities / McChem' },
    'Maintenance':              { id:'maintenance',      name:'Maintenance' },
    'Welding L3 Instructor':    { id:'welding_l3',       name:'Welding Level 3' },
    'Electrical L3 Instructor': { id:'electrical_l3',    name:'Electrical Installation L3' },
    'Welding Instructor':       { id:'welding_inst',     name:'Welding Instructor Regular' },
    'BT Instructor':            { id:'bt_inst',          name:'BT Instructor' },
    'Electrical Instructor':    { id:'electrical_inst',  name:'Electrical Instructor' },
    'BNV Welding Instructor':   { id:'bnv_welding',      name:'BNV Welding' },
    'BNV Electrical Instructor':{ id:'bnv_electrical',   name:'BNV Electrical' },
    'Data Instructor':          { id:'data_inst',        name:'Data Instructor' },
    'Remedial English':         { id:'remedial_eng',     name:'Remedial English' },
    'Personal Dev':             { id:'pers_dev',         name:'Personal Development' },
    'Entrep Instructor':        { id:'entrep_inst',      name:'Entrepreneurship Instructor' },
    'Math Instructor':          { id:'math_inst',        name:'Math Instructor' },
    'Bank Charges':             { id:'bank_charge',      name:'Bank Charges' },
    'Travelling':               { id:'travelling',       name:'Travelling' },
    'Lunch':                    { id:'lunch',             name:'Lunch' }
};

function getQuarterMeta(q) { return QUARTER_META.find(m => m.q === q); }

function getQuarterCalendarYear(fy, q) {
    const startYear = parseInt(fy.split('/')[0]);
    return q === 4 ? startYear + 1 : startYear;
}
function getQuarterPeriodLabel(fy, q) {
    const meta = getQuarterMeta(q);
    const yr = getQuarterCalendarYear(fy, q);
    return meta.monthNames[0] + ' to ' + meta.monthNames[2] + ' ' + yr;
}
function getQuarterShortLabel(fy, q) {
    const meta = getQuarterMeta(q);
    const yr = getQuarterCalendarYear(fy, q);
    return meta.shortLabel.replace('‚Äì','-').toUpperCase() + ' ' + yr;
}

// Determine fiscal year and quarter from a date string or Date object.
// Returns { fy: '2025/2026', q: 3 }
function getFYQuarterFromDate(dateVal) {
    const d = (dateVal instanceof Date) ? dateVal : new Date(dateVal);
    if (isNaN(d.getTime())) return null;
    const month = d.getMonth() + 1; // 1-12
    const year = d.getFullYear();
    // FY starts in April
    const fyStart = month >= 4 ? year : year - 1;
    const fy = fyStart + '/' + (fyStart + 1);
    const q = (month >= 4 && month <= 6) ? 1
            : (month >= 7 && month <= 9) ? 2
            : (month >= 10 && month <= 12) ? 3 : 4;
    return { fy, q };
}

// Get all FY+Q cache keys that have data in cloudQuarterCache
function getCachedQuarterKeys() {
    return Object.keys(cloudQuarterCache).filter(key => {
        const c = cloudQuarterCache[key];
        return c && c.budget && Object.keys(c.budget).length > 0;
    });
}

// Check if a specific FY+Q has cached data
function hasQuarterData(fy, q) {
    const key = fy + '_Q' + q;
    const c = cloudQuarterCache[key];
    return !!(c && c.budget && Object.keys(c.budget).length > 0);
}

// Get all unique fiscal years that have cached data
function getCachedFiscalYears() {
    const fys = new Set();
    getCachedQuarterKeys().forEach(key => {
        const parts = key.split('_Q');
        if (parts.length === 2) fys.add(parts[0]);
    });
    return Array.from(fys).sort();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Dynamic budget data ‚Äî populated by loadBudgetForQuarter() on init
// Starts empty; will be filled from cloud cache or show all-zeros
let budgetData = Object.values(CASHBOOK_CATEGORY_MAP).map(m => ({
    id: m.id, name: m.name, allocated: 0, actual: 0
}));

let virementRequests = [];
let currentModalIdx = -1;

// ==================== CLOUD CONNECTIVITY NOTIFICATIONS ====================
let cloudNotifyTimer = null;
let cloudCheckInterval = null;

function showCloudNotification(type, title, message, showConnect, autoDismissSec){
  // Remove any existing notification
  dismissCloudNotification();

  const el = document.createElement('div');
  el.id = 'cloudNotifyPopup';
  el.className = 'cloud-notify ' + type;
  const icon = type === 'error' ? '‚ö†Ô∏è' : type === 'warn' ? 'üîå' : '‚òÅÔ∏è';
  el.innerHTML =
    '<div class="cloud-notify-bar"></div>' +
    '<div class="cloud-notify-body">' +
      '<div class="cloud-notify-icon">' + icon + '</div>' +
      '<div class="cloud-notify-content">' +
        '<div class="cloud-notify-title">' + title + '</div>' +
        '<div class="cloud-notify-msg">' + message + '</div>' +
      '</div>' +
      '<button class="cloud-notify-close" onclick="dismissCloudNotification()">&times;</button>' +
    '</div>' +
    '<div class="cloud-notify-actions">' +
      (showConnect ? '<button class="btn btn-success" onclick="dismissCloudNotification();connectToGoogleDrive()">Connect Now</button>' : '') +
      '<button class="btn btn-ghost" onclick="dismissCloudNotification()">Dismiss</button>' +
    '</div>' +
    (autoDismissSec ? '<div class="cloud-notify-timer" style="animation:notifyCountdown ' + autoDismissSec + 's linear forwards"></div>' : '');

  document.body.appendChild(el);
  // Trigger slide-in
  requestAnimationFrame(function(){ requestAnimationFrame(function(){ el.classList.add('show'); }); });

  if (autoDismissSec) {
    cloudNotifyTimer = setTimeout(dismissCloudNotification, autoDismissSec * 1000);
  }
}

function dismissCloudNotification(){
  clearTimeout(cloudNotifyTimer);
  cloudNotifyTimer = null;
  const el = document.getElementById('cloudNotifyPopup');
  if (el) {
    el.classList.remove('show');
    setTimeout(function(){ el.remove(); }, 400);
  }
}

// Check cloud connection state and notify if needed
function checkCloudAndNotify(reason){
  // Don't nag if user has never connected (no saved token at all and no saved file)
  const hasEverConnected = localStorage.getItem('schoolDashboardGoogleAccessToken') ||
                           localStorage.getItem('schoolDashboardCloudFileId') ||
                           localStorage.getItem('schoolDashboardLastSyncTime');
  if (!hasEverConnected) return;

  if (!navigator.onLine) {
    showCloudNotification('error', 'You Are Offline',
      'Your internet connection is unavailable. Data changes will only be saved locally. Please reconnect to sync with Google Drive.',
      false, 0);
    return;
  }

  if (!isCloudConnected) {
    const savedExpiry = localStorage.getItem('schoolDashboardGoogleTokenExpiry');
    const lastSync = localStorage.getItem('schoolDashboardLastSyncTime');
    let detail = '';

    if (savedExpiry && new Date(savedExpiry) <= new Date()) {
      detail = 'Your Google Drive session has expired.';
    } else if (reason === 'page_load') {
      detail = 'Google Drive is not connected.';
    } else if (reason === 'token_expired') {
      detail = 'Your Google Drive session has expired.';
    } else {
      detail = 'Google Drive connection was lost.';
    }

    if (lastSync) {
      detail += ' Last sync: ' + getTimeAgo(new Date(lastSync)) + '.';
    }

    showCloudNotification('warn', 'Cloud Sync Disconnected',
      detail + ' Your data is only saved locally. Connect to Google Drive to back up and sync your data.',
      true, 30);
  }
}

// Monitor token expiry in real time
function startCloudMonitor(){
  // Clear any previous interval
  if (cloudCheckInterval) clearInterval(cloudCheckInterval);

  // Check every 60 seconds if the token has expired
  cloudCheckInterval = setInterval(function(){
    if (isCloudConnected && googleAccessToken) {
      const savedExpiry = localStorage.getItem('schoolDashboardGoogleTokenExpiry');
      if (savedExpiry && new Date(savedExpiry) <= new Date()) {
        // Token just expired
        googleAccessToken = null;
        isCloudConnected = false;
        updateCloudUI(false);
        checkCloudAndNotify('token_expired');
      }
    }
  }, 60000);
}

// Listen for browser online/offline events
window.addEventListener('offline', function(){
  showCloudNotification('error', 'You Are Offline',
    'Internet connection lost. Data changes will only be saved locally until you reconnect.',
    false, 0);
});

window.addEventListener('online', function(){
  dismissCloudNotification();
  if (!isCloudConnected) {
    // Back online but cloud not connected ‚Äî prompt to reconnect
    setTimeout(function(){
      checkCloudAndNotify('reconnected');
    }, 1500);
  } else {
    showCloudNotification('warn', 'Back Online',
      'Internet connection restored. Your cloud sync is active.',
      false, 8);
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', function(){
    loadAllData();
    loadCloudCache();
    // Populate fiscal year dropdown
    populateFYSelector();
    // Set initial quarter tab as active based on auto-detected quarter
    document.querySelectorAll('.quarter-tab-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i + 1 === virementActiveQ);
    });
    // Load budget data from cloud cache (Google Drive only)
    loadBudgetForQuarter();
    updateVirementPeriod();
    updateQuarterTabIndicators();
    renderBudgetOverview();
    renderRequests();
    renderPrintPreview();
    addVirementLine();
    // Initialize cloud sync
    initializeCloudSync();
    setTimeout(() => { initGoogleAuth(); }, 500);

    // After init, check cloud status and notify if disconnected
    setTimeout(function(){
      checkCloudAndNotify('page_load');
      startCloudMonitor();
    }, 2000);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TAB SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab, btn){
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-'+tab).classList.add('active');
    btn.classList.add('active');
    if(tab==='preview') renderPrintPreview();
    if(tab==='overview') renderBudgetOverview();
    if(tab==='admin' && adminUnlocked) renderAdminApprovals();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FORMAT HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmt(n){ return '$' + Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:2, maximumFractionDigits:2}); }
function fmtSigned(n){ return (n<0?'-':'') + fmt(n); }
function numberToWords(n){
    if(n===0) return 'Zero dollars';
    const ones=['','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten',
                'Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
    const tens=['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
    function w(num){
        if(num===0) return '';
        if(num<20) return ones[num];
        if(num<100) return tens[Math.floor(num/10)]+(num%10?' '+ones[num%10]:'');
        if(num<1000) return ones[Math.floor(num/100)]+' Hundred'+(num%100?' and '+w(num%100):'');
        if(num<1000000) return w(Math.floor(num/1000))+' Thousand'+(num%1000?', '+w(num%1000):'');
        return w(Math.floor(num/1000000))+' Million'+(num%1000000?', '+w(num%1000000):'');
    }
    let dollars = Math.floor(n);
    let cents = Math.round((n - dollars)*100);
    let result = w(dollars) + ' Dollars';
    if(cents>0) result += ' and ' + w(cents) + ' Cents';
    return result;
}

// Get virement requests for the active quarter only.
// Old requests without fy/quarter fields are treated as Q3 2025/2026.
function getActiveQuarterRequests() {
    return virementRequests.filter(r => {
        const rFY = r.fy || '2025/2026';
        const rQ = r.quarter || 3;
        return rFY === virementActiveFY && rQ === virementActiveQ;
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUDGET OVERVIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBudgetOverview(){
    // Update quarter display elements
    updateQuarterDisplay();

    let totalAlloc=0, totalActual=0, totalSurplus=0, totalDeficit=0;
    budgetData.forEach(item=>{
        let v = item.allocated - item.actual;
        totalAlloc += item.allocated;
        totalActual += item.actual;
        if(v>0) totalSurplus += v;
        else totalDeficit += Math.abs(v);
    });
    let netVariance = totalAlloc - totalActual;
    let quarterRequests = getActiveQuarterRequests();
    let totalVired = quarterRequests.reduce((s,r)=>s+r.lines.reduce((a,l)=>a+l.amount,0),0);

    // Dynamic quarter label for stats
    let quarterLabel = getQuarterShortLabel(virementActiveFY, virementActiveQ) + ' Subvention';
    let noDataNote = budgetDataSource === 'no-data' ? ' (no data)' : '';

    // Stats
    document.getElementById('statsRow').innerHTML = `
        <div class="stat-card gold"><div class="label">Total Allocated</div><div class="value">${fmt(totalAlloc)}</div><div class="sub">${quarterLabel}${noDataNote}</div></div>
        <div class="stat-card sky"><div class="label">Total Actual</div><div class="value">${fmt(totalActual)}</div><div class="sub">Expenditure to date${noDataNote}</div></div>
        <div class="stat-card emerald"><div class="label">Total Surplus Lines</div><div class="value">${fmt(totalSurplus)}</div><div class="sub">Available for virement</div></div>
        <div class="stat-card rose"><div class="label">Total Deficit Lines</div><div class="value">${fmt(totalDeficit)}</div><div class="sub">Requiring additional funds</div></div>
        <div class="stat-card gold"><div class="label">Net Variance</div><div class="value">${fmtSigned(netVariance)}</div><div class="sub">${netVariance>=0?'Under budget':'Over budget'}</div></div>
        <div class="stat-card sky"><div class="label">Total Vired</div><div class="value">${fmt(totalVired)}</div><div class="sub">${quarterRequests.length} request(s) this quarter</div></div>
    `;

    // Charts
    let surplusItems = budgetData.filter(i=>(i.allocated-i.actual)>0).sort((a,b)=>(b.allocated-b.actual)-(a.allocated-a.actual));
    let deficitItems = budgetData.filter(i=>(i.allocated-i.actual)<0).sort((a,b)=>(a.allocated-a.actual)-(b.allocated-b.actual));
    let maxVal = Math.max(...budgetData.map(i=>Math.abs(i.allocated-i.actual)),1);

    let surplusBars = surplusItems.map(i=>{
        let v = i.allocated - i.actual;
        let pct = (v/maxVal*100).toFixed(1);
        return `<div class="bar-row"><div class="bar-label">${i.name}</div><div class="bar-track"><div class="bar-fill surplus" style="width:${pct}%"></div></div><div class="bar-value pos num">${fmt(v)}</div></div>`;
    }).join('');

    let deficitBars = deficitItems.map(i=>{
        let v = Math.abs(i.allocated - i.actual);
        let pct = (v/maxVal*100).toFixed(1);
        return `<div class="bar-row"><div class="bar-label">${i.name}</div><div class="bar-track"><div class="bar-fill deficit" style="width:${pct}%"></div></div><div class="bar-value neg num">-${fmt(v)}</div></div>`;
    }).join('');

    document.getElementById('chartArea').innerHTML = `
        <div class="chart-card"><h4>üìà Surplus Line Items (Available to Vire)</h4><div class="bar-chart">${surplusBars}</div></div>
        <div class="chart-card"><h4>üìâ Deficit Line Items (Require Funding)</h4><div class="bar-chart">${deficitBars}</div></div>
    `;

    // Table
    let tbody = '';
    budgetData.forEach((item,i)=>{
        let v = item.allocated - item.actual;
        let cls = v>0?'pos':v<0?'neg':'zero';
        let statusBadge = v>0?'<span class="badge badge-approved">Surplus</span>':v<0?'<span class="badge badge-pending" style="background:rgba(244,63,94,0.15);color:var(--rose);">Deficit</span>':'<span class="badge" style="background:rgba(148,163,184,0.1);color:var(--slate);">Balanced</span>';
        tbody += `<tr>
            <td style="color:var(--text-dim);">${i+1}</td>
            <td>${item.name}</td>
            <td class="num">${fmt(item.allocated)}</td>
            <td class="num">${fmt(item.actual)}</td>
            <td class="num ${cls}">${fmtSigned(v)}</td>
            <td>${statusBadge}</td>
        </tr>`;
    });
    document.getElementById('budgetBody').innerHTML = tbody;

    let tVariance = totalAlloc - totalActual;
    document.getElementById('budgetFoot').innerHTML = `<tr style="background:rgba(212,168,67,0.08);">
        <td></td>
        <td style="font-weight:700;color:var(--gold);">TOTALS</td>
        <td class="num" style="font-weight:700;">${fmt(totalAlloc)}</td>
        <td class="num" style="font-weight:700;">${fmt(totalActual)}</td>
        <td class="num ${tVariance>=0?'pos':'neg'}" style="font-weight:700;">${fmtSigned(tVariance)}</td>
        <td></td>
    </tr>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VIREMENT FORM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getLineOptions(type){
    let items = budgetData;
    if(type==='from') items = budgetData.filter(i=>(i.allocated-i.actual)>0);
    if(type==='to') items = budgetData.filter(i=>(i.allocated-i.actual)<0);
    return '<option value="">‚Äî Select ‚Äî</option>' + items.map(i=>{
        let v = i.allocated - i.actual;
        let info = type==='from' ? `Surplus: ${fmt(v)}` : `Deficit: ${fmt(Math.abs(v))}`;
        return `<option value="${i.id}">${i.name} (${info})</option>`;
    }).join('');
}

function getAllLineOptions(){
    return '<option value="">‚Äî Select ‚Äî</option>' + budgetData.map(i=>{
        let v = i.allocated - i.actual;
        let status = v>0 ? `Surplus: ${fmt(v)}` : v<0 ? `Deficit: ${fmt(Math.abs(v))}` : 'Balanced';
        return `<option value="${i.id}">${i.name} (${status})</option>`;
    }).join('');
}

function addVirementLine(){
    let container = document.getElementById('virementLines');
    let div = document.createElement('div');
    div.className = 'virement-entry';
    div.innerHTML = `
        <div class="field">
            <label>From Line Item</label>
            <select class="vl-from" onchange="updateVirementTotal()">${getLineOptions('from')}</select>
        </div>
        <div class="field">
            <label>Amount ($)</label>
            <input type="number" step="0.01" min="0" class="vl-amount" onchange="updateVirementTotal()" oninput="updateVirementTotal()" placeholder="0.00">
        </div>
        <div class="field">
            <label>To Line Item</label>
            <select class="vl-to" onchange="updateVirementTotal()">${getLineOptions('to')}</select>
        </div>
        <button class="remove-btn" onclick="this.parentElement.remove();updateVirementTotal();">‚úï</button>
    `;
    container.appendChild(div);
}

function addAnyLineLine(){
    let container = document.getElementById('virementAnyLines');
    let div = document.createElement('div');
    div.className = 'virement-entry';
    div.innerHTML = `
        <div class="field">
            <label>From Line Item</label>
            <select class="vl-from" onchange="updateVirementTotal()">${getLineOptions('from')}</select>
        </div>
        <div class="field">
            <label>Amount ($)</label>
            <input type="number" step="0.01" min="0" class="vl-amount" onchange="updateVirementTotal()" oninput="updateVirementTotal()" placeholder="0.00">
        </div>
        <div class="field">
            <label>To Line Item</label>
            <select class="vl-to" onchange="updateVirementTotal()">${getAllLineOptions()}</select>
        </div>
        <button class="remove-btn" onclick="this.parentElement.remove();updateVirementTotal();">‚úï</button>
    `;
    container.appendChild(div);
}

function updateVirementTotal(){
    let total = 0;
    document.querySelectorAll('#virementLines .virement-entry, #virementAnyLines .virement-entry').forEach(entry=>{
        let amt = parseFloat(entry.querySelector('.vl-amount').value) || 0;
        total += amt;
    });
    document.getElementById('virementTotal').textContent = fmt(total);
}

function clearVirementForm(){
    document.getElementById('virementLines').innerHTML = '';
    document.getElementById('virementAnyLines').innerHTML = '';
    document.getElementById('deficitComment').value = '';
    document.getElementById('anyLineComment').value = '';
    addVirementLine();
    updateVirementTotal();
}

function submitVirement(){
    let lines = [];
    let hasIncomplete = false;
    function collectEntries(selector, extraProps){
        document.querySelectorAll(selector).forEach(entry=>{
            let from = entry.querySelector('.vl-from').value;
            let to = entry.querySelector('.vl-to').value;
            let amount = parseFloat(entry.querySelector('.vl-amount').value) || 0;
            // Skip completely empty/untouched rows
            if(!from && !to && amount<=0) return;
            // Partially filled row ‚Äî flag as incomplete
            if(!from || !to || amount<=0){ hasIncomplete = true; return; }
            lines.push(Object.assign({
                fromId: from,
                fromName: budgetData.find(b=>b.id===from).name,
                toId: to,
                toName: budgetData.find(b=>b.id===to).name,
                amount: amount
            }, extraProps || {}));
        });
    }
    collectEntries('#virementLines .virement-entry', {});
    collectEntries('#virementAnyLines .virement-entry', { anyLine: true });
    // Check for partially filled rows first (more specific error)
    if(hasIncomplete){
        alert('Some transfer lines are incomplete. Each line needs a From item, To item, and a positive amount. Remove or complete any partial rows.');
        return;
    }
    if(lines.length===0){
        alert('Please add at least one transfer line and fill in all fields.');
        return;
    }
    let deficitComment = document.getElementById('deficitComment').value.trim();
    let anyLineComment = document.getElementById('anyLineComment').value.trim();
    let totalAmt = lines.reduce((s,l)=>s+l.amount, 0);
    let request = {
        id: Date.now(),
        date: new Date().toISOString().split('T')[0],
        fy: virementActiveFY,
        quarter: virementActiveQ,
        project: document.getElementById('vProjectName').value,
        period: document.getElementById('vPeriod').value,
        requestedBy: document.getElementById('vRequestedBy').value,
        position: document.getElementById('vPosition').value,
        total: totalAmt,
        totalWords: numberToWords(totalAmt),
        lines: lines,
        deficitComment: deficitComment,
        anyLineComment: anyLineComment,
        status: 'Pending'
    };
    virementRequests.push(request);
    saveAllData();
    clearVirementForm();
    renderRequests();
    renderBudgetOverview();
    alert('Virement request #' + virementRequests.length + ' submitted successfully!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VIREMENT LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRequests(){
    let container = document.getElementById('requestsList');
    let quarterRequests = getActiveQuarterRequests();
    document.getElementById('requestCount').textContent = quarterRequests.length + ' request(s)';
    if(quarterRequests.length===0){
        container.innerHTML = '<div style="text-align:center;padding:3rem;color:var(--text-dim);">No virement requests for this quarter. Go to "Create Virement" to add one.</div>';
        return;
    }
    container.innerHTML = quarterRequests.map((r)=>{
        let globalIdx = virementRequests.indexOf(r);
        let badge = r.status==='Approved' ? '<span class="badge badge-approved">Approved</span>'
            : r.status==='Rejected' ? '<span class="badge badge-rejected">Rejected</span>'
            : '<span class="badge badge-pending">Pending</span>';
        let summaryLines = r.lines.map(l=>`${l.fromName} ‚Üí ${l.toName}`).join(', ');
        if(summaryLines.length>80) summaryLines = summaryLines.substring(0,80)+'‚Ä¶';
        return `<div class="virement-list-item" onclick="showDetail(${globalIdx})">
            <div class="vl-info">
                <h4>Virement #${globalIdx+1} ‚Äî ${r.date} ${badge}</h4>
                <p>${summaryLines}</p>
            </div>
            <div class="vl-amount">${fmt(r.total)}</div>
        </div>`;
    }).join('');
}

function showDetail(idx){
    currentModalIdx = idx;
    let r = virementRequests[idx];
    document.getElementById('modalTitle').textContent = 'Virement #'+(idx+1)+' ‚Äî '+r.date;
    let deficitLines = r.lines.filter(l=>!l.anyLine);
    let anyLines = r.lines.filter(l=>l.anyLine);
    let deficitHtml = deficitLines.map(l=>`<tr><td>${l.fromName}</td><td class="num">${fmt(l.amount)}</td><td>${l.toName}</td></tr>`).join('');
    let anyHtml = anyLines.map(l=>`<tr><td>${l.fromName}</td><td class="num">${fmt(l.amount)}</td><td>${l.toName}</td></tr>`).join('');
    let deficitCommentHtml = r.deficitComment ? `<p style="font-size:0.8rem;color:var(--text-dim);margin-top:0.4rem;font-style:italic;">Reason: ${r.deficitComment}</p>` : '';
    let anyCommentHtml = r.anyLineComment ? `<p style="font-size:0.8rem;color:var(--text-dim);margin-top:0.4rem;font-style:italic;">Reason: ${r.anyLineComment}</p>` : '';
    let deficitTable = deficitLines.length > 0 ? `
        <h4 style="font-size:0.8rem;color:var(--text-dim);margin:0.75rem 0 0.5rem;">Surplus ‚Üí Deficit Transfers</h4>
        <table>
            <thead><tr><th>From Line Item</th><th class="num">Amount</th><th>To Line Item</th></tr></thead>
            <tbody>${deficitHtml}</tbody>
        </table>${deficitCommentHtml}` : '';
    let anyTable = anyLines.length > 0 ? `
        <h4 style="font-size:0.8rem;color:var(--gold);margin:0.75rem 0 0.5rem;">Transfers to Any Line</h4>
        <table>
            <thead><tr><th>From Line Item</th><th class="num">Amount</th><th>To Line Item</th></tr></thead>
            <tbody>${anyHtml}</tbody>
        </table>${anyCommentHtml}` : '';
    document.getElementById('modalBody').innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;">
            <div><span style="color:var(--text-dim);font-size:0.75rem;">Project</span><br>${r.project}</div>
            <div><span style="color:var(--text-dim);font-size:0.75rem;">Period</span><br>${r.period}</div>
            <div><span style="color:var(--text-dim);font-size:0.75rem;">Requested By</span><br>${r.requestedBy||'‚Äî'}</div>
            <div><span style="color:var(--text-dim);font-size:0.75rem;">Total</span><br><strong style="color:var(--gold);font-size:1.2rem;">${fmt(r.total)}</strong></div>
        </div>
        ${deficitTable}
        ${anyTable}
        <p style="margin-top:0.75rem;font-size:0.82rem;color:var(--text-dim);font-style:italic;">${r.totalWords}</p>
        ${r.status !== 'Pending' ? `<div class="ali-stamp ${r.status==='Approved'?'stamp-approved':'stamp-rejected'}" style="margin-top:1rem;">
            ${r.status==='Approved'?'‚úì':'‚úó'} ${r.status} by ${r.approvedBy||'Admin'}${r.approvalDate?' on '+r.approvalDate:''}${r.approvalComment?' ‚Äî "'+r.approvalComment+'"':''}
        </div>` : ''}
    `;
    document.getElementById('detailModal').classList.add('show');
}
function closeModal(){ document.getElementById('detailModal').classList.remove('show'); }
function deleteCurrentVirement(){
    if(currentModalIdx>=0 && confirm('Delete this virement request?')){
        virementRequests.splice(currentModalIdx,1);
        saveAllData(); renderRequests(); renderBudgetOverview(); closeModal();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRINT PREVIEW (matching Word doc format)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPrintPreview(){
    let area = document.getElementById('printPreviewArea');
    let quarterRequests = getActiveQuarterRequests();
    if(quarterRequests.length===0){
        area.innerHTML = '<div style="text-align:center;padding:3rem;color:#999;">No virement requests for this quarter to preview.</div>';
        return;
    }
    area.innerHTML = quarterRequests.map((r,idx)=>{
        let deficitLines = r.lines.filter(l=>!l.anyLine);
        let anyLines = r.lines.filter(l=>l.anyLine);
        let deficitRows = deficitLines.map(l=>`
            <tr><td>${l.fromName}</td><td style="text-align:right;">${fmt(l.amount)}</td><td>${l.toName}</td></tr>
        `).join('');
        let anyLineRows = anyLines.map(l=>`
            <tr><td>${l.fromName}</td><td style="text-align:right;">${fmt(l.amount)}</td><td>${l.toName}</td></tr>
        `).join('');
        let deficitCommentPrint = r.deficitComment ? `<p style="margin-top:0.5rem;font-style:italic;font-size:0.85em;"><strong>Reason:</strong> ${r.deficitComment}</p>` : '';
        let anyCommentPrint = r.anyLineComment ? `<p style="margin-top:0.5rem;font-style:italic;font-size:0.85em;"><strong>Reason:</strong> ${r.anyLineComment}</p>` : '';
        let deficitSection = deficitLines.length > 0 ? `
                <p style="margin-top:0.75rem;font-weight:600;">Funds Vired will be re-allocated as follows:</p>
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>From Line Item(s)</th>
                            <th style="text-align:right;">Amount</th>
                            <th>To Line Item(s) ‚Äî Deficit</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${deficitRows}
                    </tbody>
                </table>
                ${deficitCommentPrint}` : '';
        let anyLineSection = anyLines.length > 0 ? `
                <p style="margin-top:1rem;font-weight:600;">Funds Vired to Other Line Items:</p>
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>From Line Item(s)</th>
                            <th style="text-align:right;">Amount</th>
                            <th>To Line Item(s)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${anyLineRows}
                    </tbody>
                </table>
                ${anyCommentPrint}` : '';
        return `
        <div class="print-page">
            <div class="print-header">
                <h1>COMMUNITY EDUCATIONAL AND SKILLS TRAINING INSTITUTE AND SERVICES LIMITED</h1>
                <h2>C.E.S.T.I.S</h2>
                <h3>REQUEST FOR VIREMENT OF FUNDS</h3>
            </div>
            <div class="print-body">
                <p><strong>Project:</strong> ${r.project}</p>
                <p>We are requesting approval to vire funds allocated in the <strong>${r.period}</strong> subvention.</p>
                <p>We are seeking approval to move a total of: <span class="amount-highlight">${fmt(r.total)} (${r.totalWords})</span></p>
                <p>as per the categories stated below.</p>
                ${deficitSection}
                ${anyLineSection}

                <div class="print-total-row">
                    Total = ${fmt(r.total)}
                </div>

                ${r.status !== 'Pending' ? `<div style="margin-top:1.5rem;padding:0.75rem 1rem;border:2px solid ${r.status==='Approved'?'#059669':'#e11d48'};border-radius:6px;">
                    <p style="font-weight:700;color:${r.status==='Approved'?'#059669':'#e11d48'};margin:0;">
                        ${r.status==='Approved'?'‚úì APPROVED':'‚úó REJECTED'} by ${r.approvedBy||'Admin'}${r.approvalDate?' ‚Äî '+r.approvalDate:''}
                    </p>
                    ${r.approvalComment?'<p style="font-size:0.85rem;margin:0.25rem 0 0;color:#333;">Comment: '+r.approvalComment+'</p>':''}
                </div>` : '<div style="margin-top:1.5rem;padding:0.75rem 1rem;border:2px dashed #d97706;border-radius:6px;"><p style="font-weight:600;color:#d97706;margin:0;">‚è≥ PENDING APPROVAL</p></div>'}

            </div>
        </div>`;
    }).join('');
}

function printVirements(){
    renderPrintPreview();
    document.querySelectorAll('.tab-panel').forEach(p=>{ p.classList.remove('active'); p.classList.remove('print-active'); });
    document.getElementById('tab-preview').classList.add('active');
    document.getElementById('tab-preview').classList.add('print-active');
    setTimeout(()=>window.print(), 200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN APPROVAL SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ADMIN_PIN = '1234'; // Default admin PIN ‚Äî change as needed
let adminUnlocked = false;
let adminFilter = 'pending';

function verifyAdminPin(){
    let pin = document.getElementById('adminPinInput').value;
    let errorEl = document.getElementById('adminPinError');
    if(pin === ADMIN_PIN){
        adminUnlocked = true;
        document.getElementById('adminGate').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
        document.getElementById('adminPinInput').value = '';
        errorEl.textContent = '';
        renderAdminApprovals();
    } else {
        errorEl.textContent = 'Incorrect PIN. Please try again.';
        document.getElementById('adminPinInput').value = '';
        document.getElementById('adminPinInput').focus();
    }
}

function lockAdminPanel(){
    adminUnlocked = false;
    document.getElementById('adminGate').style.display = 'block';
    document.getElementById('adminDashboard').style.display = 'none';
}

function setAdminFilter(filter, btn){
    adminFilter = filter;
    document.querySelectorAll('.admin-filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderAdminApprovals();
}

function renderAdminApprovals(){
    if(!adminUnlocked) return;
    let quarterRequests = getActiveQuarterRequests();

    // Count stats
    let pendingCount = quarterRequests.filter(r => r.status === 'Pending').length;
    let approvedCount = quarterRequests.filter(r => r.status === 'Approved').length;
    let rejectedCount = quarterRequests.filter(r => r.status === 'Rejected').length;

    document.getElementById('approvalStats').innerHTML = `
        <div class="approval-stat-card">
            <div class="stat-num pending-num">${pendingCount}</div>
            <div class="stat-label">Pending</div>
        </div>
        <div class="approval-stat-card">
            <div class="stat-num approved-num">${approvedCount}</div>
            <div class="stat-label">Approved</div>
        </div>
        <div class="approval-stat-card">
            <div class="stat-num rejected-num">${rejectedCount}</div>
            <div class="stat-label">Rejected</div>
        </div>
    `;

    // Filter
    let filtered = quarterRequests;
    if(adminFilter === 'pending') filtered = quarterRequests.filter(r => r.status === 'Pending');
    else if(adminFilter === 'approved') filtered = quarterRequests.filter(r => r.status === 'Approved');
    else if(adminFilter === 'rejected') filtered = quarterRequests.filter(r => r.status === 'Rejected');

    let container = document.getElementById('approvalList');
    if(filtered.length === 0){
        let emptyMsg = adminFilter === 'pending' ? 'No pending virement requests for this quarter.'
            : adminFilter === 'approved' ? 'No approved requests for this quarter.'
            : adminFilter === 'rejected' ? 'No rejected requests for this quarter.'
            : 'No virement requests for this quarter.';
        container.innerHTML = `<div style="text-align:center;padding:3rem;color:var(--text-dim);">${emptyMsg}</div>`;
        return;
    }

    container.innerHTML = filtered.map(r => {
        let globalIdx = virementRequests.indexOf(r);
        let badge = r.status === 'Approved' ? '<span class="badge badge-approved">Approved</span>'
            : r.status === 'Rejected' ? '<span class="badge badge-rejected">Rejected</span>'
            : '<span class="badge badge-pending">Pending</span>';
        let summaryLines = r.lines.map(l => `${l.fromName} ‚Üí ${l.toName}`).join(', ');
        if(summaryLines.length > 100) summaryLines = summaryLines.substring(0,100) + '‚Ä¶';

        let actionsHtml = '';
        if(r.status === 'Pending'){
            actionsHtml = `
                <div class="ali-actions">
                    <input type="text" class="approval-comment-input" id="approvalComment_${globalIdx}" placeholder="Comment (optional)">
                    <button class="btn-approve" onclick="approveVirement(${globalIdx})">‚úì Approve</button>
                    <button class="btn-reject" onclick="rejectVirement(${globalIdx})">‚úó Reject</button>
                </div>`;
        } else {
            let stampClass = r.status === 'Approved' ? 'stamp-approved' : 'stamp-rejected';
            let stampIcon = r.status === 'Approved' ? '‚úì' : '‚úó';
            let stampText = `${stampIcon} ${r.status} by ${r.approvedBy || 'Admin'}`;
            if(r.approvalDate) stampText += ` on ${r.approvalDate}`;
            if(r.approvalComment) stampText += ` ‚Äî "${r.approvalComment}"`;
            actionsHtml = `<div class="ali-stamp ${stampClass}">${stampText}</div>`;
        }

        return `<div class="approval-list-item">
            <div class="ali-top">
                <div>
                    <h4>Virement #${globalIdx+1} ‚Äî ${r.date} ${badge}</h4>
                </div>
                <div class="ali-amount">${fmt(r.total)}</div>
            </div>
            <div class="ali-meta">
                <span>Project: ${r.project}</span>
                <span>Period: ${r.period}</span>
                <span>Requested by: ${r.requestedBy || '‚Äî'}</span>
            </div>
            <div class="ali-lines">${summaryLines}</div>
            ${actionsHtml}
        </div>`;
    }).join('');
}

function approveVirement(idx){
    let r = virementRequests[idx];
    if(!r || r.status !== 'Pending') return;
    let comment = document.getElementById('approvalComment_' + idx);
    r.status = 'Approved';
    r.approvedBy = 'Admin';
    r.approvalDate = new Date().toISOString().split('T')[0];
    r.approvalComment = comment ? comment.value.trim() : '';
    saveAllData();
    renderAdminApprovals();
    renderRequests();
}

function rejectVirement(idx){
    let r = virementRequests[idx];
    if(!r || r.status !== 'Pending') return;
    let comment = document.getElementById('approvalComment_' + idx);
    let commentText = comment ? comment.value.trim() : '';
    if(!commentText){
        if(!confirm('Reject this virement without a comment? It is recommended to provide a reason.')){
            if(comment) comment.focus();
            return;
        }
    }
    r.status = 'Rejected';
    r.approvedBy = 'Admin';
    r.approvalDate = new Date().toISOString().split('T')[0];
    r.approvalComment = commentText;
    saveAllData();
    renderAdminApprovals();
    renderRequests();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SAVE / LOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveAllData(){
    localStorage.setItem('cesti_virements', JSON.stringify(virementRequests));
}
function loadAllData(){
    try {
        let saved = localStorage.getItem('cesti_virements');
        if(saved) virementRequests = JSON.parse(saved);
    } catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  QUARTER SWITCHING & BUDGET SYNC FROM CASHBOOK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Switch the active quarter and reload budget data
function switchVirementQuarter(q) {
    if (q === virementActiveQ) return;
    virementActiveQ = q;
    // Update quarter tab buttons
    document.querySelectorAll('.quarter-tab-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i + 1 === q);
    });
    // Load budget data from cloud cache for this quarter
    loadBudgetForQuarter();
    // Update the period input in the virement form
    updateVirementPeriod();
    // Update quarter tab data indicators (dots don't change per quarter switch
    // within same FY, but keeping for consistency)
    updateQuarterTabIndicators();
    // Re-render everything
    renderBudgetOverview();
    renderRequests();
    renderPrintPreview();
    if(adminUnlocked) renderAdminApprovals();
    // Refresh virement form dropdowns
    document.getElementById('virementLines').innerHTML = '';
    addVirementLine();
    updateVirementTotal();
}

// Update the period field in the virement form based on active quarter
function updateVirementPeriod() {
    const periodLabel = getQuarterPeriodLabel(virementActiveFY, virementActiveQ);
    const periodInput = document.getElementById('vPeriod');
    if (periodInput) periodInput.value = periodLabel;
}

// Update quarter UI elements (header, FY selector, source badge)
function updateQuarterDisplay() {
    const headerEl = document.getElementById('budgetTableHeader');
    const badge = document.getElementById('budgetSourceBadge');
    if (headerEl) {
        headerEl.textContent = 'Budget Line Items ‚Äî ' + getQuarterShortLabel(virementActiveFY, virementActiveQ);
    }
    // Keep FY dropdown in sync
    const fySelect = document.getElementById('fySelect');
    if (fySelect) {
        if (!Array.from(fySelect.options).some(o => o.value === virementActiveFY)) {
            populateFYSelector();
        }
        fySelect.value = virementActiveFY;
    }
    if (badge) {
        const cachedCount = getCachedQuarterKeys().length;
        if (budgetDataSource === 'cashbook-local') {
            badge.textContent = 'SYNCED FROM CASHBOOK';
            badge.className = 'budget-source-badge synced';
        } else if (budgetDataSource === 'cashbook-cloud') {
            badge.textContent = cachedCount > 1 ? 'SYNCED (' + cachedCount + ' QUARTERS)' : 'SYNCED FROM CLOUD';
            badge.className = 'budget-source-badge cloud';
        } else if (budgetDataSource === 'no-data') {
            badge.textContent = cachedCount > 0 ? 'NO DATA (other quarters available)' : 'NO DATA';
            badge.className = 'budget-source-badge no-data';
        } else {
            badge.textContent = 'DEFAULT DATA';
            badge.className = 'budget-source-badge default';
        }
    }
    // Show/hide the empty state banner and update its text
    const emptyBanner = document.getElementById('quarterEmptyBanner');
    if (emptyBanner) {
        emptyBanner.style.display = budgetDataSource === 'no-data' ? 'flex' : 'none';
        if (budgetDataSource === 'no-data') {
            const emptyText = document.getElementById('quarterEmptyText');
            if (emptyText) {
                const cachedKeys = getCachedQuarterKeys();
                if (cachedKeys.length > 0) {
                    // Show which quarters DO have data
                    const availableList = cachedKeys.map(key => {
                        const parts = key.split('_Q');
                        const qMeta = getQuarterMeta(parseInt(parts[1]));
                        return parts[0] + ' ' + qMeta.label;
                    }).join(', ');
                    emptyText.innerHTML = '<strong>No Cashbook data for this quarter.</strong> Data is available for: ' + availableList + '. Switch quarters using the tabs above, or <em>Sync Budget from Cashbook</em> to pull the latest data.';
                } else {
                    emptyText.innerHTML = '<strong>No Cashbook data available for this quarter.</strong> Use <em>Sync Budget from Cashbook</em> to pull cloud data for all available quarters.';
                }
            }
        }
    }
}

// Update quarter tab indicators to show which quarters have data
function updateQuarterTabIndicators() {
    for (let q = 1; q <= 4; q++) {
        const dot = document.getElementById('qDot' + q);
        if (dot) {
            dot.className = hasQuarterData(virementActiveFY, q) ? 'q-data-dot has-data' : 'q-data-dot no-data';
        }
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FISCAL YEAR SELECTOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Generate list of available fiscal years (range around current + all cached)
function getFiscalYearOptions() {
    const now = new Date();
    const currentMonth = now.getMonth() + 1; // 1-12
    const currentYear = now.getFullYear();
    // FY starts in April: if Jan-Mar, we're in the FY that started last year
    const currentFYStart = currentMonth >= 4 ? currentYear : currentYear - 1;
    const fySet = new Set();
    // Show 3 years back and 1 year forward from current FY
    for (let y = currentFYStart - 3; y <= currentFYStart + 1; y++) {
        fySet.add(y + '/' + (y + 1));
    }
    // Include all fiscal years that have cached data
    getCachedFiscalYears().forEach(fy => fySet.add(fy));
    return Array.from(fySet).sort();
}

// Populate the FY dropdown and select the active FY
function populateFYSelector() {
    const select = document.getElementById('fySelect');
    if (!select) return;
    const options = getFiscalYearOptions();
    // Also include the active FY if not already in range
    if (!options.includes(virementActiveFY)) {
        options.push(virementActiveFY);
        options.sort();
    }
    select.innerHTML = options.map(fy =>
        '<option value="' + fy + '"' + (fy === virementActiveFY ? ' selected' : '') + '>FY ' + fy + '</option>'
    ).join('');
}

// Switch fiscal year and reload data
function switchFiscalYear(fy) {
    if (fy === virementActiveFY) return;
    virementActiveFY = fy;
    // Reload budget data for the new FY + current quarter
    loadBudgetForQuarter();
    updateVirementPeriod();
    updateQuarterTabIndicators();
    renderBudgetOverview();
    renderRequests();
    renderPrintPreview();
    // Refresh virement form
    document.getElementById('virementLines').innerHTML = '';
    addVirementLine();
    updateVirementTotal();
    // Update FY dropdown selection
    const select = document.getElementById('fySelect');
    if (select) select.value = fy;
}

// Navigate FY forward/backward via arrow buttons
function shiftFiscalYear(direction) {
    const startYear = parseInt(virementActiveFY.split('/')[0]) + direction;
    const newFY = startYear + '/' + (startYear + 1);
    // Update dropdown options if needed
    const select = document.getElementById('fySelect');
    if (select && !Array.from(select.options).some(o => o.value === newFY)) {
        const opt = document.createElement('option');
        opt.value = newFY;
        opt.textContent = 'FY ' + newFY;
        if (direction > 0) {
            select.appendChild(opt);
        } else {
            select.insertBefore(opt, select.firstChild);
        }
    }
    switchFiscalYear(newFY);
}

// Load cloud cache from localStorage on startup
function loadCloudCache() {
    try {
        const cached = localStorage.getItem(VIREMENT_CLOUD_CACHE_KEY);
        if (cached) cloudQuarterCache = JSON.parse(cached);
    } catch(e) {
        console.error('Error loading cloud cache:', e);
        cloudQuarterCache = {};
    }
}

// Save cloud cache to localStorage
function saveCloudCache() {
    try {
        localStorage.setItem(VIREMENT_CLOUD_CACHE_KEY, JSON.stringify(cloudQuarterCache));
    } catch(e) {
        console.error('Error saving cloud cache:', e);
    }
}

// Load budget data for the active quarter from the cloud cache only.
// If no cloud data exists for this quarter, show all zeros.
function loadBudgetForQuarter() {
    const cacheKey = virementActiveFY + '_Q' + virementActiveQ;
    const cached = cloudQuarterCache[cacheKey];

    if (cached && cached.budget && Object.keys(cached.budget).length > 0) {
        const sourceBudget = cached.budget;
        const transactions = cached.transactions || [];

        // Calculate actual spend per category from transactions
        const catSpend = {};
        transactions.forEach(t => {
            if (t.category !== 'Cancelled' && t.category !== 'Subvention' && t.payment > 0) {
                catSpend[t.category] = (catSpend[t.category] || 0) + t.payment;
            }
        });

        // Build budgetData
        const newBudgetData = [];
        Object.keys(sourceBudget).forEach(catName => {
            const mapping = CASHBOOK_CATEGORY_MAP[catName];
            if (mapping) {
                newBudgetData.push({
                    id: mapping.id,
                    name: mapping.name,
                    allocated: sourceBudget[catName],
                    actual: catSpend[catName] || 0
                });
            }
        });

        // Add any categories with actual spend that aren't in the budget
        Object.keys(catSpend).forEach(catName => {
            if (!sourceBudget.hasOwnProperty(catName)) {
                const mapping = CASHBOOK_CATEGORY_MAP[catName];
                if (mapping && !newBudgetData.find(b => b.id === mapping.id)) {
                    newBudgetData.push({
                        id: mapping.id,
                        name: mapping.name,
                        allocated: 0,
                        actual: catSpend[catName]
                    });
                }
            }
        });

        if (newBudgetData.length > 0) {
            budgetData = newBudgetData;
            budgetDataSource = 'cashbook-cloud';
            updateQuarterDisplay();
            return true;
        }
    }

    // No cloud data for this quarter ‚Äî all zeros
    budgetData = Object.values(CASHBOOK_CATEGORY_MAP).map(mapping => ({
        id: mapping.id,
        name: mapping.name,
        allocated: 0,
        actual: 0
    }));
    budgetDataSource = 'no-data';
    updateQuarterDisplay();
    return false;
}

// Sync budget data from Cashbook Dashboard's cloud backup (Google Drive).
// Downloads the backup, parses ALL available quarters, stores each in the
// per-quarter cloud cache, then renders the active quarter.
async function syncBudgetFromCashbook() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first to sync budget data from the Cashbook cloud backup.');
        return;
    }

    const syncBtn = document.getElementById('syncBudgetBtn');
    if (syncBtn) { syncBtn.disabled = true; syncBtn.innerHTML = '<span class="spinning">üîÑ</span> Syncing...'; }

    try {
        // Search for the Cashbook backup file in the Cashbook Google Drive folder
        const cashbookFileName = 'CESTIS_CASHBOOK_DASHBOARD_BACKUP.json';
        const query = "name='" + cashbookFileName + "' and '" + GOOGLE_DRIVE_CONFIG.CASHBOOK_FOLDER_ID + "' in parents and trashed=false";
        const searchResponse = await fetch(
            'https://www.googleapis.com/drive/v3/files?q=' + encodeURIComponent(query) + '&fields=files(id,name,modifiedTime)',
            { headers: { 'Authorization': 'Bearer ' + googleAccessToken } }
        );

        if (!searchResponse.ok) throw new Error('Failed to search for Cashbook backup');

        const searchData = await searchResponse.json();
        if (!searchData.files || searchData.files.length === 0) {
            throw new Error('No Cashbook Dashboard backup found in the Cashbook Google Drive folder.\nPlease save from the Cashbook Dashboard first.');
        }

        const cashbookFileId = searchData.files[0].id;

        // Download the Cashbook backup
        const downloadResponse = await fetch(
            'https://www.googleapis.com/drive/v3/files/' + cashbookFileId + '?alt=media',
            { headers: { 'Authorization': 'Bearer ' + googleAccessToken } }
        );

        if (!downloadResponse.ok) throw new Error('Failed to download Cashbook backup');

        const cashbookBackup = await downloadResponse.json();

        if (!cashbookBackup.data) throw new Error('Invalid Cashbook backup format');

        const cloudDeletedBudgetKeys = cashbookBackup.data.deletedBudgetKeys || [];
        const cloudFY = cashbookBackup.data.activeFY || virementActiveFY;
        const cloudQ = cashbookBackup.data.activeQ || virementActiveQ;
        let quartersPopulated = [];
        let totalTransactions = 0;

        // ‚îÄ‚îÄ STRATEGY 1: Per-quarter data structure ‚îÄ‚îÄ
        // Check if backup contains explicit per-quarter data (e.g., quarterData, quarters, allQuarters)
        const perQuarterData = cashbookBackup.data.quarterData
            || cashbookBackup.data.quarters
            || cashbookBackup.data.allQuarters
            || null;

        if (perQuarterData && typeof perQuarterData === 'object') {
            // Process each quarter from the per-quarter structure
            Object.keys(perQuarterData).forEach(key => {
                const qd = perQuarterData[key];
                const qBudget = { ...(qd.budget || {}) };
                const qTransactions = qd.transactions || [];
                // Remove deleted budget keys
                const qDeleted = qd.deletedBudgetKeys || cloudDeletedBudgetKeys;
                qDeleted.forEach(k => delete qBudget[k]);

                // Normalize key format to "YYYY/YYYY+1_QN"
                let cacheKey = key;
                if (!key.includes('_Q')) {
                    // Try to parse if it's just "Q3" or "2025/2026-Q3" etc.
                    const qMatch = key.match(/(\d{4}\/\d{4})[_\-]?Q?(\d)/i);
                    if (qMatch) cacheKey = qMatch[1] + '_Q' + qMatch[2];
                }

                if (Object.keys(qBudget).length > 0 || qTransactions.length > 0) {
                    cloudQuarterCache[cacheKey] = {
                        budget: qBudget,
                        transactions: qTransactions,
                        syncedAt: new Date().toISOString()
                    };
                    quartersPopulated.push(cacheKey);
                    totalTransactions += qTransactions.length;
                }
            });
        }

        // ‚îÄ‚îÄ STRATEGY 2: Single budget + all transactions ‚Äî split by date ‚îÄ‚îÄ
        // If no per-quarter data was found, or as a supplement, process
        // the flat budget & transactions arrays
        const cloudBudget = cashbookBackup.data.budget || {};
        const cloudTransactions = cashbookBackup.data.transactions || [];

        // Remove deleted budget keys from the flat budget
        const cleanBudget = { ...cloudBudget };
        cloudDeletedBudgetKeys.forEach(k => delete cleanBudget[k]);

        if (cloudTransactions.length > 0) {
            // Group transactions by fiscal year and quarter based on date
            const txByQuarter = {};
            let undatedCount = 0;

            cloudTransactions.forEach(t => {
                // Try to parse the transaction date from common fields
                const txDate = t.date || t.transactionDate || t.dt || null;
                const fqInfo = txDate ? getFYQuarterFromDate(txDate) : null;

                if (fqInfo) {
                    const key = fqInfo.fy + '_Q' + fqInfo.q;
                    if (!txByQuarter[key]) txByQuarter[key] = [];
                    txByQuarter[key].push(t);
                } else {
                    // Transactions without parseable dates go to the backup's active quarter
                    undatedCount++;
                    const fallbackKey = cloudFY + '_Q' + cloudQ;
                    if (!txByQuarter[fallbackKey]) txByQuarter[fallbackKey] = [];
                    txByQuarter[fallbackKey].push(t);
                }
            });

            // Create/update cache entries for each quarter found in transactions
            Object.keys(txByQuarter).forEach(key => {
                // Only update if this quarter wasn't already populated by Strategy 1
                if (!quartersPopulated.includes(key)) {
                    cloudQuarterCache[key] = {
                        budget: { ...cleanBudget },
                        transactions: txByQuarter[key],
                        syncedAt: new Date().toISOString()
                    };
                    quartersPopulated.push(key);
                    totalTransactions += txByQuarter[key].length;
                } else {
                    // Merge transactions if quarter already exists but add any new ones
                    const existing = cloudQuarterCache[key];
                    const existingIds = new Set(existing.transactions.map(t => t.id || JSON.stringify(t)));
                    txByQuarter[key].forEach(t => {
                        const tId = t.id || JSON.stringify(t);
                        if (!existingIds.has(tId)) {
                            existing.transactions.push(t);
                            totalTransactions++;
                        }
                    });
                }
            });

            if (undatedCount > 0) {
                console.warn('syncBudgetFromCashbook: ' + undatedCount + ' transactions had no parseable date, assigned to ' + cloudFY + '_Q' + cloudQ);
            }
        } else if (quartersPopulated.length === 0 && Object.keys(cleanBudget).length > 0) {
            // No transactions at all, but we have budget data ‚Äî store for the active quarter
            const fallbackKey = cloudFY + '_Q' + cloudQ;
            cloudQuarterCache[fallbackKey] = {
                budget: { ...cleanBudget },
                transactions: [],
                syncedAt: new Date().toISOString()
            };
            quartersPopulated.push(fallbackKey);
        }

        saveCloudCache();

        // Sort populated quarters for display
        quartersPopulated.sort();

        // Switch to the backup's active quarter (or the most recent quarter with data)
        let navFY = cloudFY;
        let navQ = cloudQ;
        if (quartersPopulated.length > 0) {
            // If the backup's active quarter has data, use it; otherwise use the latest
            const activeKey = cloudFY + '_Q' + cloudQ;
            if (!quartersPopulated.includes(activeKey)) {
                const latest = quartersPopulated[quartersPopulated.length - 1];
                const parts = latest.split('_Q');
                navFY = parts[0];
                navQ = parseInt(parts[1]);
            }
        }

        virementActiveFY = navFY;
        virementActiveQ = navQ;
        document.querySelectorAll('.quarter-tab-btn').forEach((btn, i) => {
            btn.classList.toggle('active', i + 1 === navQ);
        });
        // Update FY dropdown to include all fiscal years with data
        populateFYSelector();

        // Load from the cloud cache
        loadBudgetForQuarter();
        updateVirementPeriod();
        updateQuarterTabIndicators();
        renderBudgetOverview();
        renderRequests();
        renderPrintPreview();
        document.getElementById('virementLines').innerHTML = '';
        addVirementLine();

        // Build a detailed summary
        const backupTime = new Date(cashbookBackup.timestamp).toLocaleString();
        const savedBy = cashbookBackup.savedBy || 'Unknown';

        let quarterSummary = quartersPopulated.map(key => {
            const parts = key.split('_Q');
            const qNum = parseInt(parts[1]);
            const qMeta = getQuarterMeta(qNum);
            const txCount = (cloudQuarterCache[key] && cloudQuarterCache[key].transactions)
                ? cloudQuarterCache[key].transactions.length : 0;
            return '  ' + parts[0] + ' ' + qMeta.label + ' (' + txCount + ' transactions)';
        }).join('\n');

        alert('Budget data synced from Cashbook cloud backup!\n\n' +
            'Quarters populated: ' + quartersPopulated.length + '\n' +
            quarterSummary + '\n\n' +
            'Active view: ' + getQuarterPeriodLabel(navFY, navQ) + '\n' +
            'Total transactions: ' + totalTransactions + '\n' +
            'Budget lines: ' + budgetData.length + '\n\n' +
            'Backup saved by: ' + savedBy + '\n' +
            'Backup date: ' + backupTime);

    } catch (error) {
        console.error('Error syncing budget from cashbook:', error);
        if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
            alert('Your session has expired. Please reconnect to Google Drive.');
            disconnectFromGoogleDrive();
        } else {
            alert('Failed to sync budget: ' + error.message);
        }
    } finally {
        if (syncBtn) { syncBtn.disabled = false; syncBtn.innerHTML = '<span>üîÑ</span> Sync Budget from Cashbook'; }
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRE-LOAD EXISTING VIREMENTS FROM WORD DOC DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function preloadFromDocData(){
    if(virementRequests.length > 0) return; // already have data

    const project = "Community Educational and Skills Training Institute and Services Limited (Hazard Skills Training Centre)";
    const period = "October to December 2025";
    const presets = [
        { total:89515.35, totalWords:"Eighty Nine Thousand, Five Hundred and Fifteen Dollars and Thirty Five Cents", lines:[
            {fromName:'Coordinator Salary', fromId:'coordinator', toName:'Statutory Deductions', toId:'statutory', amount:24807.99},
            {fromName:'Training Material', fromId:'training_mat', toName:'Statutory Deductions', toId:'statutory', amount:64707.45}
        ]},
        { total:44288.25, totalWords:"Forty Four Thousand, Two Hundred and Eighty Eight Dollars and Twenty Five Cents", lines:[
            {fromName:'Assistant Coordinator', fromId:'asst_coord', toName:'Statutory Deductions', toId:'statutory', amount:16807.05},
            {fromName:'Math Instructor', fromId:'math_inst', toName:'Travelling', toId:'travelling', amount:27481.20}
        ]},
        { total:85292.52, totalWords:"Eighty Five Thousand, Two Hundred and Ninety Two Dollars and Fifty Two Cents", lines:[
            {fromName:'Training Material', fromId:'training_mat', toName:'Admin Expenses', toId:'admin', amount:85292.52}
        ]},
        { total:100000.00, totalWords:"One Hundred Thousand Dollars", lines:[
            {fromName:'Assessor Fees', fromId:'assessor', toName:'Admin Expenses', toId:'admin', amount:100000.00}
        ]},
        { total:96415.28, totalWords:"Ninety Six Thousand, Four Hundred and Fifteen Dollars and Twenty Eight Cents", lines:[
            {fromName:'Assessor Fees', fromId:'assessor', toName:'Admin Expenses', toId:'admin', amount:35415.28},
            {fromName:'Assessor Fees', fromId:'assessor', toName:'Maintenance', toId:'maintenance', amount:14584.72},
            {fromName:'Utilities / McChem', fromId:'utilities', toName:'Maintenance', toId:'maintenance', amount:12225.65},
            {fromName:'Welding Level 3', fromId:'welding_l3', toName:'Maintenance', toId:'maintenance', amount:8091.99},
            {fromName:'Electrical Installation L3', fromId:'electrical_l3', toName:'Maintenance', toId:'maintenance', amount:26097.64}
        ]},
        { total:100000.00, totalWords:"One Hundred Thousand Dollars", lines:[
            {fromName:'Assessor Fees', fromId:'assessor', toName:'Maintenance', toId:'maintenance', amount:100000.00}
        ]},
        { total:100000.00, totalWords:"One Hundred Thousand Dollars", lines:[
            {fromName:'Utilities / McChem', fromId:'utilities', toName:'Maintenance', toId:'maintenance', amount:100000.00}
        ]},
        { total:100000.00, totalWords:"One Hundred Thousand Dollars", lines:[
            {fromName:'Welding Level 3', fromId:'welding_l3', toName:'Maintenance', toId:'maintenance', amount:100000.00}
        ]},
        { total:100000.00, totalWords:"One Hundred Thousand Dollars", lines:[
            {fromName:'Welding Level 3', fromId:'welding_l3', toName:'Maintenance', toId:'maintenance', amount:100000.00}
        ]},
        { total:100000.00, totalWords:"One Hundred Thousand Dollars", lines:[
            {fromName:'Welding Level 3', fromId:'welding_l3', toName:'Maintenance', toId:'maintenance', amount:100000.00}
        ]},
        { total:81994.35, totalWords:"Eighty One Thousand, Nine Hundred and Ninety Four Dollars and Thirty Five Cents", lines:[
            {fromName:'Electrical Installation L3', fromId:'electrical_l3', toName:'Lunch', toId:'lunch', amount:81994.35}
        ]},
        { total:86548.64, totalWords:"Eighty Six Thousand, Five Hundred and Forty Eight Dollars and Sixty Four Cents", lines:[
            {fromName:'Welding Instructor Regular', fromId:'welding_inst', toName:'Lunch', toId:'lunch', amount:20673.33},
            {fromName:'BT Instructor', fromId:'bt_inst', toName:'Lunch', toId:'lunch', amount:20673.33},
            {fromName:'Electrical Instructor', fromId:'electrical_inst', toName:'Lunch', toId:'lunch', amount:20673.33},
            {fromName:'BNV Welding', fromId:'bnv_welding', toName:'Lunch', toId:'lunch', amount:20673.33},
            {fromName:'Data Instructor', fromId:'data_inst', toName:'Lunch', toId:'lunch', amount:1927.66},
            {fromName:'Entrepreneurship Instructor', fromId:'entrep_inst', toName:'Lunch', toId:'lunch', amount:1927.66}
        ]},
        { total:79996.27, totalWords:"Seventy Nine Thousand, Nine Hundred and Ninety Six Dollars and Twenty Seven Cents", lines:[
            {fromName:'BNV Electrical', fromId:'bnv_electrical', toName:'Lunch', toId:'lunch', amount:20673.33},
            {fromName:'Remedial English', fromId:'remedial_eng', toName:'Lunch', toId:'lunch', amount:59322.94}
        ]},
        { total:100000.00, totalWords:"One Hundred Thousand Dollars", lines:[
            {fromName:'Electrical Installation L3', fromId:'electrical_l3', toName:'Lunch', toId:'lunch', amount:100000.00}
        ]},
        { total:100000.00, totalWords:"One Hundred Thousand Dollars", lines:[
            {fromName:'Electrical Installation L3', fromId:'electrical_l3', toName:'Lunch', toId:'lunch', amount:100000.00}
        ]},
        { total:100000.00, totalWords:"One Hundred Thousand Dollars", lines:[
            {fromName:'Remedial English', fromId:'remedial_eng', toName:'Lunch', toId:'lunch', amount:100000.00}
        ]},
        { total:51460.74, totalWords:"Fifty One Thousand, Four Hundred and Sixty Dollars and Seventy Four Cents", lines:[
            {fromName:'Electrical Installation L3', fromId:'electrical_l3', toName:'Lunch', toId:'lunch', amount:51460.74}
        ]}
    ];

    presets.forEach((p,i)=>{
        virementRequests.push({
            id: Date.now()+i,
            date: '2025-10-01',
            fy: '2025/2026',
            quarter: 3,
            project: project,
            period: period,
            requestedBy: '',
            position: 'Assistant Coordinator',
            total: p.total,
            totalWords: p.totalWords,
            lines: p.lines,
            status: 'Pending'
        });
    });
    saveAllData();
    renderRequests();
    renderBudgetOverview();
    renderPrintPreview();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GOOGLE DRIVE CLOUD SYNC INTEGRATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Google Drive Configuration
const GOOGLE_DRIVE_CONFIG = {
    CLIENT_ID: '302497466088-0b619cqa9qno2c606k4rqp742lebc5o8.apps.googleusercontent.com',
    FOLDER_ID: '1G6ipD_pGVItBvlPx0LGbD6Prj6AXW303',
    CASHBOOK_FOLDER_ID: '1aL_QZiJ5rmxQUBhj261PzdbYXrI5doOO',
    BACKUP_FILE_NAME: 'Cashbook_Virement_Backup.json',
    SCOPES: 'https://www.googleapis.com/auth/drive'
};

// Cloud sync state
let googleAccessToken = null;
let isCloudConnected = false;
let lastSyncTime = null;
let cloudFileId = null;
let lastSavedBy = null;
let cloudFileTimestamp = null;
let googleTokenClient = null;

// Initialize cloud sync from localStorage
function initializeCloudSync() {
    const savedToken = localStorage.getItem('schoolDashboardGoogleAccessToken');
    const savedExpiry = localStorage.getItem('schoolDashboardGoogleTokenExpiry');
    const savedLastSync = localStorage.getItem('schoolDashboardLastSyncTime');

    if (savedLastSync) {
        lastSyncTime = new Date(savedLastSync);
        updateLastSyncDisplay();
    }

    if (savedToken && savedExpiry) {
        const expiry = new Date(savedExpiry);
        if (expiry > new Date()) {
            googleAccessToken = savedToken;
            isCloudConnected = true;
            updateCloudUI(true);
            // Re-lookup the backup file in the configured folder to ensure
            // cloudFileId points to the correct folder (not a stale cached ID)
            findExistingBackupFile();
            return;
        }
    }

    updateCloudUI(false);
}

// Update cloud UI based on connection status
function updateCloudUI(connected) {
    const notConnectedDiv = document.getElementById('cloudNotConnected');
    const connectedDiv = document.getElementById('cloudConnected');
    const statusDot = document.getElementById('cloudStatusDot');
    const statusText = document.getElementById('cloudStatusText');

    if (connected) {
        notConnectedDiv.style.display = 'none';
        connectedDiv.style.display = 'block';
        statusDot.className = 'cloud-status-dot connected';
        statusText.textContent = 'Connected';
    } else {
        notConnectedDiv.style.display = 'block';
        connectedDiv.style.display = 'none';
        statusDot.className = 'cloud-status-dot';
        statusText.textContent = 'Not connected';
    }
}

// Update syncing status
function setCloudSyncing(syncing) {
    const statusDot = document.getElementById('cloudStatusDot');
    const statusText = document.getElementById('cloudStatusText');
    const menuIcon = document.getElementById('cloudMenuIcon');
    const connectedDot = document.getElementById('cloudStatusDotConnected');
    const connectedText = document.getElementById('cloudStatusTextConnected');
    const statusLabel = document.getElementById('cloudStatusLabel');

    if (syncing) {
        statusDot.className = 'cloud-status-dot syncing';
        statusText.textContent = 'Syncing...';
        menuIcon.innerHTML = '<span class="spinning">üîÑ</span>';
        if (connectedDot) connectedDot.className = 'cloud-status-dot syncing';
        if (connectedText) connectedText.textContent = 'Syncing...';
        if (statusLabel) { statusLabel.className = 'cloud-status-label connected'; }
    } else {
        statusDot.className = 'cloud-status-dot connected';
        statusText.textContent = 'Connected';
        menuIcon.textContent = '‚òÅÔ∏è';
        if (connectedDot) connectedDot.className = 'cloud-status-dot connected';
        if (connectedText) connectedText.textContent = 'Connected';
        if (statusLabel) { statusLabel.className = 'cloud-status-label connected'; }
    }
}

// Toggle cloud dropdown menu
function toggleCloudMenu() {
    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.toggle('show');

    setTimeout(() => {
        document.addEventListener('click', closeCloudMenuOnClickOutside);
    }, 0);
}

function closeCloudMenuOnClickOutside(e) {
    const menu = document.getElementById('cloudDropdownMenu');
    const dropdown = document.querySelector('.cloud-dropdown');

    if (!dropdown.contains(e.target)) {
        menu.classList.remove('show');
        document.removeEventListener('click', closeCloudMenuOnClickOutside);
    }
}

// Initialize Google Identity Services
function initGoogleAuth() {
    if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
        googleTokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
            scope: GOOGLE_DRIVE_CONFIG.SCOPES,
            callback: handleGoogleAuthCallback,
            error_callback: handleGoogleAuthError
        });
    }
}

// Connect to Google Drive using OAuth
async function connectToGoogleDrive() {
    showGoogleAuthModal();
}

// Show authentication modal with two options
function showGoogleAuthModal() {
    const modalHTML = `
    <div id="googleAuthModal" class="google-auth-modal" style="display: flex;">
        <div class="modal-content" style="max-width: 560px;">
            <div class="modal-header">
                <h2>‚òÅÔ∏è Connect to Google Drive</h2>
                <button class="close-btn" onclick="closeGoogleAuthModal()">√ó</button>
            </div>
            <div style="padding: var(--space-6);">
                <p style="margin-bottom: var(--space-5); color: var(--text-secondary);">
                    Connect to Google Drive to save and sync your dashboard data across devices. Choose your preferred connection method:
                </p>

                <!-- Option 1: Direct Google Sign-In (Recommended) -->
                <div style="background: var(--success-bg); border: 2px solid var(--success); border-radius: var(--radius-lg); padding: var(--space-5); margin-bottom: var(--space-4);">
                    <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3);">
                        <span style="font-size: 1.5rem;">üîê</span>
                        <div>
                            <strong style="color: var(--success); font-size: 1.1rem;">Direct Google Sign-In</strong>
                            <span style="background: var(--success); color: white; padding: 2px 8px; border-radius: var(--radius-sm); font-size: 0.7rem; margin-left: var(--space-2); font-weight: 600;">RECOMMENDED</span>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: var(--space-4);">
                        A Google popup will appear for you to sign in with your Google account directly.
                    </p>
                    <button class="btn btn-success" onclick="triggerDirectGoogleSignIn()" style="width: 100%; padding: var(--space-3);">
                        Sign in with Google
                    </button>
                </div>

                <!-- Option 2: Manual Token Method -->
                <div id="manualTokenSection" style="background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: var(--radius-lg); padding: var(--space-5);">
                    <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3);">
                        <span style="font-size: 1.5rem;">üîß</span>
                        <strong style="color: var(--text-primary); font-size: 1.1rem;">Manual Token Method</strong>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: var(--space-4);">
                        If the popup doesn't work, you can still use the OAuth Playground to get a token manually.
                    </p>
                    <button class="btn btn-secondary" onclick="showManualTokenForm()" id="showManualTokenBtn" style="width: 100%;">
                        Use Manual Method
                    </button>

                    <!-- Manual token form (hidden by default) -->
                    <div id="manualTokenForm" style="display: none; margin-top: var(--space-4);">
                        <div style="background: var(--info-bg); border: 1px solid var(--info-border); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-4);">
                            <strong style="color: var(--info);">How to get your access token:</strong>
                            <ol style="margin-top: var(--space-2); margin-left: var(--space-4); color: var(--text-secondary); font-size: 0.85rem; line-height: 1.6;">
                                <li>Click the link below to open Google OAuth Playground</li>
                                <li>In Step 1, find and select <strong>"Drive API v3"</strong> ‚Üí check <strong>"../auth/drive"</strong> (full access to shared files)</li>
                                <li>Click <strong>"Authorize APIs"</strong> (blue button)</li>
                                <li>Sign in with your Google account</li>
                                <li>In Step 2, click <strong>"Exchange authorization code for tokens"</strong></li>
                                <li>Copy the <strong>"Access token"</strong> value and paste below</li>
                            </ol>
                            <a href="https://developers.google.com/oauthplayground" target="_blank"
                               style="display: inline-block; margin-top: var(--space-3); padding: var(--space-2) var(--space-4); background: var(--accent); color: white; border-radius: var(--radius-md); text-decoration: none; font-weight: 600; font-size: 0.875rem;">
                                üîó Open OAuth Playground
                            </a>
                        </div>

                        <div style="margin-bottom: var(--space-4);">
                            <label style="font-weight: 600; color: var(--text);">Access Token</label>
                            <textarea id="googleAccessTokenInput" rows="4" style="width: 100%; padding: var(--space-3); border: 2px solid var(--border-light); border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem; resize: vertical; margin-top: var(--space-2); background: var(--navy); color: var(--text);" placeholder="Paste your access token here..."></textarea>
                        </div>

                        <button class="btn btn-success" onclick="submitGoogleToken()" style="width: 100%;">
                            ‚òÅÔ∏è Connect with Token
                        </button>
                    </div>
                </div>

                <div style="margin-top: var(--space-4); text-align: center;">
                    <button class="btn btn-secondary" onclick="closeGoogleAuthModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Trigger the direct Google Sign-In popup
function triggerDirectGoogleSignIn() {
    closeGoogleAuthModal();
    if (googleTokenClient) {
        googleTokenClient.requestAccessToken();
    } else {
        initGoogleAuth();
        setTimeout(() => {
            if (googleTokenClient) {
                googleTokenClient.requestAccessToken();
            } else {
                alert('Google Sign-In popup is not available. Please use the manual token method.');
                showGoogleAuthModal();
                setTimeout(() => showManualTokenForm(), 100);
            }
        }, 500);
    }
}

// Show the manual token form
function showManualTokenForm() {
    const form = document.getElementById('manualTokenForm');
    const btn = document.getElementById('showManualTokenBtn');
    if (form && btn) {
        form.style.display = 'block';
        btn.style.display = 'none';
    }
}

function closeGoogleAuthModal() {
    const modal = document.getElementById('googleAuthModal');
    if (modal) modal.remove();
}

async function submitGoogleToken() {
    const tokenInput = document.getElementById('googleAccessTokenInput');
    const token = tokenInput.value.trim();

    if (!token) {
        alert('Please enter an access token');
        return;
    }

    try {
        const response = await fetch('https://www.googleapis.com/drive/v3/about?fields=user', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Invalid token');

        const data = await response.json();

        googleAccessToken = token;
        isCloudConnected = true;

        const expiry = new Date();
        expiry.setHours(expiry.getHours() + 1);
        localStorage.setItem('schoolDashboardGoogleAccessToken', token);
        localStorage.setItem('schoolDashboardGoogleTokenExpiry', expiry.toISOString());

        closeGoogleAuthModal();
        updateCloudUI(true);

        alert(`‚úÖ Connected to Google Drive as ${data.user.displayName || data.user.emailAddress}`);

        await findExistingBackupFile();

        // Auto-sync budget data from Cashbook after connecting
        autoSyncCashbookOnConnect();

    } catch (error) {
        console.error('Token verification failed:', error);
        alert('‚ùå Invalid access token. Please make sure you copied the correct token.');
    }
}

async function handleGoogleAuthCallback(tokenResponse) {
    googleAccessToken = tokenResponse.access_token;
    isCloudConnected = true;

    const expiry = new Date();
    expiry.setSeconds(expiry.getSeconds() + (tokenResponse.expires_in || 3600));
    localStorage.setItem('schoolDashboardGoogleAccessToken', googleAccessToken);
    localStorage.setItem('schoolDashboardGoogleTokenExpiry', expiry.toISOString());

    updateCloudUI(true);

    await findExistingBackupFile();

    // Auto-sync budget data from Cashbook after connecting
    autoSyncCashbookOnConnect();
}

// Automatically sync Cashbook budget data when connecting to Google Drive,
// if no cached data exists yet for the current quarter.
async function autoSyncCashbookOnConnect() {
    const cachedKeys = getCachedQuarterKeys();
    // Only auto-sync if we have no cached data at all or current quarter has no data
    if (cachedKeys.length === 0 || !hasQuarterData(virementActiveFY, virementActiveQ)) {
        try {
            await syncBudgetFromCashbook();
        } catch(e) {
            console.log('Auto-sync on connect skipped or failed:', e.message);
        }
    }
}

function handleGoogleAuthError(error) {
    console.error('Google auth error:', error);
    if (error.type === 'popup_closed') return;
    alert('Failed to authenticate with Google. Please try the manual token method.');
    showGoogleAuthModal();
}

// Disconnect from Google Drive
function disconnectFromGoogleDrive() {
    if (confirm('Are you sure you want to disconnect from Google Drive? Your local data will remain intact.')) {
        googleAccessToken = null;
        isCloudConnected = false;
        cloudFileId = null;

        localStorage.removeItem('schoolDashboardGoogleAccessToken');
        localStorage.removeItem('schoolDashboardGoogleTokenExpiry');
        localStorage.removeItem('schoolDashboardCloudFileId');

        updateCloudUI(false);
        toggleCloudMenu();

        alert('‚úÖ Disconnected from Google Drive');
    }
}

// Find existing backup file in the folder
async function findExistingBackupFile() {
    try {
        const query = `name='${GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME}' and '${GOOGLE_DRIVE_CONFIG.FOLDER_ID}' in parents and trashed=false`;
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,modifiedTime)`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (response.ok) {
            const data = await response.json();
            if (data.files && data.files.length > 0) {
                cloudFileId = data.files[0].id;
                localStorage.setItem('schoolDashboardCloudFileId', cloudFileId);
                console.log('Found existing backup file:', cloudFileId);
            } else {
                cloudFileId = null;
                localStorage.removeItem('schoolDashboardCloudFileId');
                console.log('No backup file found with name:', GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME);
            }
        }
    } catch (error) {
        console.error('Error finding backup file:', error);
    }
}

// Check cloud file for changes before saving (multi-user conflict detection)
async function checkCloudForChanges() {
    if (!cloudFileId || !googleAccessToken) return null;

    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (response.ok) {
            const backupData = await response.json();
            return {
                savedBy: backupData.savedBy || 'Unknown',
                timestamp: backupData.timestamp
            };
        }
    } catch (error) {
        console.error('Error checking cloud for changes:', error);
    }
    return null;
}

// ‚îÄ‚îÄ‚îÄ SAVE TO CLOUD ‚îÄ‚îÄ‚îÄ
async function saveToCloud() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first');
        return;
    }

    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.remove('show');

    const cloudInfo = await checkCloudForChanges();

    let confirmMessage = '‚ö†Ô∏è MULTI-USER CLOUD SYNC\n\n';
    confirmMessage += 'You are about to save to a shared cloud backup.\n\n';

    if (cloudInfo && cloudInfo.savedBy) {
        const cloudTime = new Date(cloudInfo.timestamp);
        const timeSinceLastSave = getTimeAgo(cloudTime);

        const hasConflict = lastSyncTime && cloudTime > lastSyncTime;

        if (hasConflict) {
            confirmMessage += `‚ö†Ô∏è WARNING: ${cloudInfo.savedBy} saved changes ${timeSinceLastSave}!\n`;
            confirmMessage += `Your local data may not include their changes.\n\n`;
            confirmMessage += `üí° Recommendation: Click Cancel, then "Sync from Cloud" first.\n\n`;
        } else {
            confirmMessage += `Last saved by: ${cloudInfo.savedBy} (${timeSinceLastSave})\n\n`;
        }
    }

    confirmMessage += 'This will overwrite the cloud backup. Continue?';

    if (!confirm(confirmMessage)) return;

    setCloudSyncing(true);

    try {
        // Always re-lookup the backup file in the configured folder before saving
        // to ensure cloudFileId is accurate and points to the correct folder
        await findExistingBackupFile();

        const savedByName = 'Dashboard User';
        const backupData = {
            version: '1.0',
            timestamp: new Date().toISOString(),
            savedBy: savedByName,
            data: {
                virementRequests: virementRequests
            }
        };

        const jsonContent = JSON.stringify(backupData, null, 2);

        let response;

        if (cloudFileId) {
            // Update existing file content
            response = await fetch(
                `https://www.googleapis.com/upload/drive/v3/files/${cloudFileId}?uploadType=media`,
                {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: jsonContent
                }
            );

            if (response.ok) {
                // Ensure the file is in the correct folder (move it if needed)
                await fetch(
                    `https://www.googleapis.com/drive/v3/files/${cloudFileId}?addParents=${GOOGLE_DRIVE_CONFIG.FOLDER_ID}&fields=id,parents`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );
            }
        } else {
            // Create new file using proper multipart/related format
            // (FormData produces multipart/form-data which may cause the
            // parents metadata to be ignored, placing the file in Drive root)
            const boundary = 'cestis_boundary_' + Date.now();
            const metadata = JSON.stringify({
                name: GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME,
                parents: [GOOGLE_DRIVE_CONFIG.FOLDER_ID],
                mimeType: 'application/json'
            });

            const multipartBody =
                `--${boundary}\r\n` +
                `Content-Type: application/json; charset=UTF-8\r\n\r\n` +
                metadata + `\r\n` +
                `--${boundary}\r\n` +
                `Content-Type: application/json\r\n\r\n` +
                jsonContent + `\r\n` +
                `--${boundary}--`;

            response = await fetch(
                'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,parents',
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': `multipart/related; boundary=${boundary}`
                    },
                    body: multipartBody
                }
            );

            if (response.ok) {
                const result = await response.json();
                cloudFileId = result.id;
                localStorage.setItem('schoolDashboardCloudFileId', cloudFileId);
            }
        }

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'Upload failed');
        }

        lastSyncTime = new Date();
        localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
        updateLastSyncDisplay();

        lastSavedBy = savedByName;
        cloudFileTimestamp = new Date().toISOString();
        updateLastSavedByDisplay();

        setCloudSyncing(false);
        alert(`‚úÖ Data saved to Google Drive successfully!\n\nSaved by: ${lastSavedBy}\n\nüí° Tip: Let other users know to sync from cloud to get your changes.`);

    } catch (error) {
        console.error('Error saving to cloud:', error);
        setCloudSyncing(false);

        if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
            alert('‚ùå Your session has expired. Please reconnect to Google Drive.');
            disconnectFromGoogleDrive();
        } else {
            alert(`‚ùå Failed to save to cloud: ${error.message}`);
        }
    }
}

// ‚îÄ‚îÄ‚îÄ SYNC FROM CLOUD ‚îÄ‚îÄ‚îÄ
async function syncFromCloud() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first');
        return;
    }

    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.remove('show');

    if (!cloudFileId) {
        await findExistingBackupFile();
    }

    if (!cloudFileId) {
        alert('üìÅ No backup file found in Google Drive. Save your data first to create a backup.');
        return;
    }

    if (!confirm('‚ö†Ô∏è This will replace your local data with the cloud backup. Are you sure you want to continue?')) {
        return;
    }

    setCloudSyncing(true);

    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (!response.ok) throw new Error('Failed to download backup');

        const backupData = await response.json();

        if (!backupData.data || !backupData.version) {
            throw new Error('Invalid backup file format');
        }

        if (backupData.data.virementRequests) {
            virementRequests = backupData.data.virementRequests;
            saveAllData();
        }

        // Reload budget from cloud cache
        loadBudgetForQuarter();

        lastSyncTime = new Date();
        localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
        updateLastSyncDisplay();

        // Refresh UI
        renderBudgetOverview();
        renderRequests();
        renderPrintPreview();

        setCloudSyncing(false);

        lastSavedBy = backupData.savedBy || 'Unknown';
        cloudFileTimestamp = backupData.timestamp;
        updateLastSavedByDisplay();

        const backupTime = new Date(backupData.timestamp).toLocaleString();
        const savedByInfo = backupData.savedBy ? `\nLast saved by: ${backupData.savedBy}` : '';
        alert(`‚úÖ Data synced from cloud successfully!\n\nBackup was created: ${backupTime}${savedByInfo}`);

    } catch (error) {
        console.error('Error syncing from cloud:', error);
        setCloudSyncing(false);

        if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
            alert('‚ùå Your session has expired. Please reconnect to Google Drive.');
            disconnectFromGoogleDrive();
        } else {
            alert(`‚ùå Failed to sync from cloud: ${error.message}`);
        }
    }
}

// ‚îÄ‚îÄ‚îÄ MERGE FROM CLOUD ‚îÄ‚îÄ‚îÄ
async function mergeFromCloud() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first');
        return;
    }

    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.remove('show');

    if (!cloudFileId) {
        await findExistingBackupFile();
    }

    if (!cloudFileId) {
        alert('üìÅ No backup file found in Google Drive. Save your data first to create a backup.');
        return;
    }

    if (!confirm('üîÄ MERGE FROM CLOUD\n\nThis will merge cloud data with your local data:\n\n‚Ä¢ New virement requests from cloud will be ADDED to your local data\n‚Ä¢ Existing requests will be kept as-is (local version preserved)\n‚Ä¢ No local data will be removed\n\nContinue?')) {
        return;
    }

    setCloudSyncing(true);

    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (!response.ok) throw new Error('Failed to download backup');

        const backupData = await response.json();

        if (!backupData.data || !backupData.version) {
            throw new Error('Invalid backup file format');
        }

        let mergeStats = { requestsAdded: 0 };

        // Merge virement requests - add cloud requests that don't exist locally (match by id)
        if (backupData.data.virementRequests) {
            const localIds = virementRequests.map(r => r.id);
            backupData.data.virementRequests.forEach(cloudRequest => {
                if (!localIds.includes(cloudRequest.id)) {
                    virementRequests.push(cloudRequest);
                    mergeStats.requestsAdded++;
                }
            });
            if (mergeStats.requestsAdded > 0) {
                saveAllData();
            }
        }

        // Reload budget from cloud cache
        loadBudgetForQuarter();

        lastSyncTime = new Date();
        localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
        updateLastSyncDisplay();

        lastSavedBy = backupData.savedBy || 'Unknown';
        cloudFileTimestamp = backupData.timestamp;
        updateLastSavedByDisplay();

        // Refresh UI
        renderBudgetOverview();
        renderRequests();
        renderPrintPreview();

        setCloudSyncing(false);

        let summary = '‚úÖ Merge from cloud completed!\n\n';
        summary += `üìä Merge Summary:\n`;
        summary += `‚Ä¢ Virement requests added: ${mergeStats.requestsAdded}\n`;

        if (mergeStats.requestsAdded === 0) {
            summary += '\nüí° No new data found ‚Äî your local data already contains everything from the cloud.';
        } else {
            summary += `\nüí° Tip: Save to Cloud to push the merged data back for other users.`;
        }

        const savedByInfo = backupData.savedBy ? `\nCloud backup was saved by: ${backupData.savedBy}` : '';
        summary += savedByInfo;

        alert(summary);

    } catch (error) {
        console.error('Error merging from cloud:', error);
        setCloudSyncing(false);

        if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
            alert('‚ùå Your session has expired. Please reconnect to Google Drive.');
            disconnectFromGoogleDrive();
        } else {
            alert(`‚ùå Failed to merge from cloud: ${error.message}`);
        }
    }
}

// ‚îÄ‚îÄ‚îÄ SYNC BUDGET FROM CASHBOOK (Cloud Menu) ‚îÄ‚îÄ‚îÄ
function syncBudgetFromCloudMenu() {
    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.remove('show');
    syncBudgetFromCashbook();
}

// ‚îÄ‚îÄ‚îÄ BROWSE ALL BACKUPS ‚îÄ‚îÄ‚îÄ
async function browseBackupFiles() {
    if (!isCloudConnected || !googleAccessToken) {
        alert('Please connect to Google Drive first');
        return;
    }

    const menu = document.getElementById('cloudDropdownMenu');
    menu.classList.remove('show');

    setCloudSyncing(true);

    try {
        // Fetch files from both the Virement folder and the Cashbook folder
        const folders = [
            { id: GOOGLE_DRIVE_CONFIG.FOLDER_ID, label: 'Virement Folder' },
            { id: GOOGLE_DRIVE_CONFIG.CASHBOOK_FOLDER_ID, label: 'Cashbook Folder' }
        ];

        let allFiles = [];
        for (const folder of folders) {
            try {
                const query = `'${folder.id}' in parents and trashed=false and mimeType='application/json'`;
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,modifiedTime,size)&orderBy=modifiedTime desc`,
                    { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
                );
                if (response.ok) {
                    const data = await response.json();
                    if (data.files) {
                        data.files.forEach(file => {
                            file._sourceFolder = folder.label;
                            allFiles.push(file);
                        });
                    }
                }
            } catch (e) {
                console.warn('Could not list files from ' + folder.label + ':', e);
            }
        }

        // Sort all files by modification time descending
        allFiles.sort((a, b) => new Date(b.modifiedTime) - new Date(a.modifiedTime));

        setCloudSyncing(false);

        const virementDriveLink = `https://drive.google.com/drive/folders/${GOOGLE_DRIVE_CONFIG.FOLDER_ID}`;
        const cashbookDriveLink = `https://drive.google.com/drive/folders/${GOOGLE_DRIVE_CONFIG.CASHBOOK_FOLDER_ID}`;

        let fileListHTML = '';
        if (allFiles.length === 0) {
            fileListHTML = `
                <div class="folder-browser-empty">
                    <span>üìÇ</span>
                    <p>No backup files found in either Google Drive folder.</p>
                </div>`;
        } else {
            allFiles.forEach(file => {
                const modified = new Date(file.modifiedTime);
                const dateStr = modified.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                const timeStr = modified.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                const sizeStr = file.size ? formatFileSize(parseInt(file.size)) : '‚Äî';
                const folderBadge = file._sourceFolder === 'Cashbook Folder'
                    ? '<span style="background:#e8f5e9;color:#2e7d32;padding:1px 6px;border-radius:4px;font-size:0.65rem;margin-left:0.35rem;">Cashbook</span>'
                    : '<span style="background:#e3f2fd;color:#1565c0;padding:1px 6px;border-radius:4px;font-size:0.65rem;margin-left:0.35rem;">Virement</span>';
                fileListHTML += `
                    <div class="folder-file-item" id="folder-file-${file.id}">
                        <div class="folder-file-info">
                            <div class="folder-file-icon">üìÑ</div>
                            <div class="folder-file-details">
                                <div class="folder-file-name" title="${file.name}">${file.name}${folderBadge}</div>
                                <div class="folder-file-meta">
                                    <span>üìÖ ${dateStr} at ${timeStr}</span>
                                    <span>üì¶ ${sizeStr}</span>
                                </div>
                            </div>
                        </div>
                        <div class="folder-file-actions">
                            <button class="folder-btn-download" onclick="downloadBackupFile('${file.id}', '${file.name.replace(/'/g, "\\'")}')">
                                ‚¨á Download
                            </button>
                            <button class="folder-btn-delete" onclick="deleteBackupFile('${file.id}', '${file.name.replace(/'/g, "\\'")}', this)" title="Delete file">
                                üóë
                            </button>
                        </div>
                    </div>`;
            });
        }

        const fileCount = allFiles.length;
        const modalHTML = `
        <div id="folderBrowserOverlay" class="folder-browser-overlay" onclick="if(event.target===this)closeFolderBrowser()">
            <div class="folder-browser">
                <div class="folder-browser-header">
                    <h2>üìÅ Cloud Folders ‚Äî All Backups${fileCount > 0 ? ' <span style="font-size:0.75rem;font-weight:500;color:var(--slate);margin-left:0.25rem;">(' + fileCount + ')</span>' : ''}</h2>
                    <button class="folder-browser-close" onclick="closeFolderBrowser()">√ó</button>
                </div>
                <div class="folder-browser-body">
                    ${fileListHTML}
                </div>
                <div class="folder-browser-footer">
                    <a href="${virementDriveLink}" target="_blank" rel="noopener noreferrer" style="margin-right:1rem;">
                        üîó Virement Folder
                    </a>
                    <a href="${cashbookDriveLink}" target="_blank" rel="noopener noreferrer">
                        üîó Cashbook Folder
                    </a>
                </div>
            </div>
        </div>`;

        document.body.insertAdjacentHTML('beforeend', modalHTML);

    } catch (error) {
        console.error('Error browsing backup files:', error);
        setCloudSyncing(false);
        alert(`Failed to browse backups: ${error.message}`);
    }
}

function closeFolderBrowser() {
    const overlay = document.getElementById('folderBrowserOverlay');
    if (overlay) overlay.remove();
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

async function downloadBackupFile(fileId, fileName) {
    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );
        if (!response.ok) throw new Error('Download failed');
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Error downloading file:', error);
        alert('Failed to download file: ' + error.message);
    }
}

async function deleteBackupFile(fileId, fileName, btnElement) {
    if (!confirm(`Delete "${fileName}"?\n\nThis will permanently remove this backup from Google Drive.`)) return;
    try {
        const response = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}`,
            { method: 'DELETE', headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );
        if (!response.ok) throw new Error('Delete failed');
        const item = document.getElementById('folder-file-' + fileId);
        if (item) {
            item.style.transition = 'opacity 0.3s, transform 0.3s';
            item.style.opacity = '0';
            item.style.transform = 'translateX(20px)';
            setTimeout(() => item.remove(), 300);
        }
        if (fileId === cloudFileId) {
            cloudFileId = null;
            localStorage.removeItem('schoolDashboardCloudFileId');
        }
    } catch (error) {
        console.error('Error deleting file:', error);
        alert('Failed to delete file: ' + error.message);
    }
}

// ‚îÄ‚îÄ‚îÄ CLOUD SYNC HELPER FUNCTIONS ‚îÄ‚îÄ‚îÄ

function updateLastSyncDisplay() {
    const lastSyncInfo = document.getElementById('lastSyncInfo');
    if (lastSyncTime) {
        const timeAgo = getTimeAgo(lastSyncTime);
        lastSyncInfo.textContent = `Last sync: ${timeAgo}`;
    } else {
        lastSyncInfo.textContent = 'Last sync: Never';
    }
}

function updateLastSavedByDisplay() {
    const lastSavedByInfo = document.getElementById('lastSavedByInfo');
    if (lastSavedByInfo) {
        if (lastSavedBy && cloudFileTimestamp) {
            const timeAgo = getTimeAgo(new Date(cloudFileTimestamp));
            lastSavedByInfo.textContent = `Last saved by: ${lastSavedBy} (${timeAgo})`;
        } else if (lastSavedBy) {
            lastSavedByInfo.textContent = `Last saved by: ${lastSavedBy}`;
        } else {
            lastSavedByInfo.textContent = 'Last saved by: --';
        }
    }
}

function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
}

// Check if first visit
if(virementRequests.length === 0){
    preloadFromDocData();
}
</script>
</body>
</html>
